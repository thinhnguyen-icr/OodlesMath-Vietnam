<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../assets/brand.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cube Divider Challenge - Time Attack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            touch-action: none;
            user-select: none;
        }

        /* ƒê·∫£m b·∫£o √¥ input lu√¥n c√≥ th·ªÉ g√µ ƒë∆∞·ª£c */
        input {
            touch-action: auto !important;
            user-select: text !important;
            -webkit-user-select: text !important;
        }

        .sky-bg {
            background: linear-gradient(to bottom, #0ea5e9 0%, #38bdf8 40%, #bae6fd 100%);
            position: relative;
            overflow: hidden;
        }

        .sun {
            position: absolute;
            top: -30px;
            left: -30px;
            width: 160px;
            height: 160px;
            background: radial-gradient(circle, #fde047 20%, #facc15 60%, transparent 70%);
            border-radius: 50%;
            box-shadow: 0 0 50px 25px rgba(253, 224, 71, 0.4);
            animation: sun-glow 4s infinite alternate;
            z-index: 0;
        }

        @keyframes sun-glow {
            from { transform: scale(1); opacity: 0.8; }
            to { transform: scale(1.1); opacity: 1; }
        }

        .cloud-base {
            position: absolute;
            color: white;
            opacity: 0.8;
            text-shadow: 0 4px 10px rgba(0,0,0,0.1);
            filter: drop-shadow(0 4px 2px rgba(0,0,0,0.05));
            pointer-events: none;
            z-index: 1;
        }
        
        .cloud-move-1 { animation: float 45s infinite linear; }
        .cloud-move-2 { animation: float 35s infinite linear reverse; }

        @keyframes float {
            from { transform: translateX(-150px); }
            to { transform: translateX(100vw); }
        }

        .cube {
            width: 24px;
            height: 24px;
            background: #3b82f6;
            border: 2px solid #1d4ed8;
            border-radius: 4px;
            box-shadow: 2px 2px 0px #1e3a8a;
            cursor: pointer;
            display: inline-block;
            margin: 2px;
            position: relative;
            z-index: 30;
            transition: transform 0.1s;
        }

        .cube:active { cursor: grabbing; transform: scale(1.1); }

        .drop-zone {
            min-height: 150px;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.35);
            border: 3px dashed rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(4px);
        }

        .drop-zone.active {
            background: rgba(255, 255, 255, 0.7);
            border-color: #3b82f6;
            transform: scale(1.01);
        }

        .ten-group {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 2px;
            background: rgba(255, 255, 255, 0.4);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            padding: 3px;
            margin-bottom: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        #dragging-cube {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        .pop-in {
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .wiggle {
            animation: wiggle 0.5s ease-in-out;
        }

        @keyframes wiggle {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        #fireworksCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 60;
        }

        .hidden-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="sky-bg h-screen w-screen flex flex-col items-center relative text-slate-800">
    <img src="../assets/logo-oodles-math.png" class="oodles-logo">
    <div class="sun"></div>
    <div class="cloud-base text-7xl cloud-move-1" style="top: 8%; left: -10%;">‚òÅÔ∏è</div>
    <div class="cloud-base text-5xl cloud-move-2" style="top: 18%; right: -10%;">‚òÅÔ∏è</div>
    
    <!-- Ghost cube for visual dragging -->
    <div id="dragging-cube" class="cube"></div>

    <!-- Setup Screen -->
    <div id="startScreen" class="absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-md w-[95%] text-center shadow-2xl border-8 border-blue-400 pop-in">
            <h1 class="text-3xl font-bold text-blue-600 mb-6">Game Setup</h1>
            
            <div class="space-y-4 mb-8 text-left">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Max Cubes per Round</label>
                    <input type="number" id="setupCubes" value="20" min="4" max="100" class="w-full text-xl font-bold border-4 border-blue-100 rounded-2xl p-2 focus:outline-none focus:border-blue-400">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Number of Groups</label>
                    <input type="number" id="setupGroups" value="2" min="2" max="5" class="w-full text-xl font-bold border-4 border-blue-100 rounded-2xl p-2 focus:outline-none focus:border-blue-400">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Game Time (Seconds)</label>
                    <input type="number" id="setupTime" value="60" min="10" max="600" class="w-full text-xl font-bold border-4 border-blue-100 rounded-2xl p-2 focus:outline-none focus:border-blue-400">
                </div>
            </div>

            <button onclick="checkAndStart()" class="w-full bg-blue-500 hover:bg-blue-600 text-white text-2xl font-bold py-4 px-8 rounded-2xl shadow-lg transition transform active:scale-95">
                START CHALLENGE
            </button>
        </div>
    </div>

    <header class="w-full p-4 flex justify-between items-center z-20 max-w-5xl">
        <div class="flex gap-2">
            <div class="bg-white/90 backdrop-blur rounded-2xl px-4 py-2 border-4 border-yellow-400 shadow-lg">
                <span class="text-xl font-bold text-yellow-600">‚è±Ô∏è <span id="timer">00:00</span></span>
            </div>
            <div class="bg-white/90 backdrop-blur rounded-2xl px-4 py-2 border-4 border-green-400 shadow-lg">
                <span class="text-xl font-bold text-green-600">‚≠ê <span id="score">0</span></span>
            </div>
        </div>
        <div class="bg-white/90 backdrop-blur rounded-2xl px-4 py-2 border-4 border-blue-400 shadow-lg">
            <span class="text-xl font-bold text-blue-600">Cubes Left: <span id="cubes-left">0</span></span>
        </div>
        <button id="muteBtn" class="bg-white/90 p-2 rounded-full border-2 border-slate-300 hover:bg-slate-100 transition shadow-md">
            üîä
        </button>
    </header>

    <main class="flex-1 w-full max-w-6xl flex flex-col p-4 z-10 overflow-hidden pt-24">
        
        <!-- Source Area -->
        <div class="bg-white/30 backdrop-blur-md border-4 border-white/50 rounded-3xl p-4 mb-4 flex-none shadow-sm">
            <h2 class="text-center font-bold text-slate-700 mb-2 uppercase tracking-wide text-xs">Source Pile (Click to move fast)</h2>
            <div id="source-pile" class="flex flex-wrap justify-center items-start gap-1 min-h-[80px] max-h-[120px] overflow-y-auto hidden-scrollbar p-2">
                <!-- Cubes generated here -->
            </div>
        </div>

        <!-- Target Bins Container -->
        <div id="bins-wrapper" class="flex-1 flex flex-wrap gap-4 min-h-0 justify-center">
            <!-- Bins generated here -->
        </div>

        <!-- Action Bar -->
        <div id="submit-section" class="mt-4 flex flex-col items-center gap-2 opacity-30 transition-opacity">
            <div class="flex gap-4 items-center bg-white/90 p-4 rounded-2xl shadow-xl border-2 border-slate-200">
                <div class="text-center">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase">Per Group</label>
                    <input type="number" id="answer-input" placeholder="?" class="w-20 text-center text-2xl font-bold border-2 border-blue-400 rounded-xl p-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="check-btn" disabled class="bg-green-500 hover:bg-green-600 disabled:bg-slate-400 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition transform active:scale-95">
                    SUBMIT
                </button>
            </div>
        </div>
    </main>

    <!-- Game Over Modal -->
    <div id="gameOverModal" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-md w-[90%] text-center shadow-2xl border-8 border-purple-400 pop-in relative">
            <h1 class="text-4xl font-bold mb-2 text-purple-600">Time's Up!</h1>
            <div class="text-6xl mb-4">‚≠ê <span id="finalScore">0</span></div>
            <p class="text-lg text-slate-600 mb-6">You solved <span id="solvedCount">0</span> rounds!</p>
            <div class="text-4xl mb-6">üéÜ ü¶Å üêØ üéÜ</div>
            <button onclick="backToSetup()" class="w-full bg-blue-500 hover:bg-blue-600 text-white text-2xl font-bold py-3 px-8 rounded-2xl shadow-lg transition transform active:scale-95">
                PLAY AGAIN ‚Ü∫
            </button>
        </div>
    </div>

    <canvas id="fireworksCanvas"></canvas>

    <script>
        // --- Game Config & State ---
        let maxCubesSetting = 20;
        let numGroupsSetting = 2;
        let gameTimeSetting = 60;
        
        let currentTotalCubes = 0;
        let timeLeft = 0;
        let score = 0;
        let gameTimer = null;
        let isMuted = false;
        let isDragging = false;
        let draggedCubeId = null;
        let lastAutoBinIndex = 0; 
        let binCubes = []; 
        let isPointerDown = false;
        let dragStartX = 0, dragStartY = 0;

        // Global DOM References
        let ghostCube, currentTargetZone;
        let startScreen, setupCubesInput, setupGroupsInput, setupTimeInput;
        let binsWrapper, sourcePile, cubesLeftDisplay, scoreDisplay, submitSection, checkBtn, answerInput;

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function initDOM() {
            ghostCube = document.getElementById('dragging-cube');
            startScreen = document.getElementById('startScreen');
            setupCubesInput = document.getElementById('setupCubes');
            setupGroupsInput = document.getElementById('setupGroups');
            setupTimeInput = document.getElementById('setupTime');
            binsWrapper = document.getElementById('bins-wrapper');
            sourcePile = document.getElementById('source-pile');
            cubesLeftDisplay = document.getElementById('cubes-left');
            scoreDisplay = document.getElementById('score');
            submitSection = document.getElementById('submit-section');
            checkBtn = document.getElementById('check-btn');
            answerInput = document.getElementById('answer-input');
        }

        function playSound(type) {
            if (isMuted) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'correct') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(523, now); osc.frequency.setValueAtTime(783, now + 0.1);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'pop') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(800, now + 0.05);
                gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.05);
                osc.start(now); osc.stop(now + 0.05);
            }
        }

        function checkAndStart() {
            maxCubesSetting = parseInt(setupCubesInput.value) || 20;
            numGroupsSetting = parseInt(setupGroupsInput.value) || 2;
            gameTimeSetting = parseInt(setupTimeInput.value) || 60;

            if (maxCubesSetting < numGroupsSetting) maxCubesSetting = numGroupsSetting;

            startScreen.classList.add('hidden');
            score = 0;
            scoreDisplay.innerText = score;
            timeLeft = gameTimeSetting;
            
            createBins();
            startMatchTimer();
            startNewRound();
        }

        function createBins() {
            binsWrapper.innerHTML = '';
            binCubes = [];
            for (let i = 0; i < numGroupsSetting; i++) {
                binCubes.push([]);
                const bin = document.createElement('div');
                bin.id = `bin-${i}`;
                bin.className = 'drop-zone flex-1 min-w-[150px] rounded-3xl flex flex-col p-4 shadow-inner relative';
                bin.innerHTML = `
                    <div class="text-center font-bold text-slate-700 mb-2 uppercase tracking-tight text-[10px]">Group ${i+1}</div>
                    <div class="flex-1 flex flex-wrap content-start justify-center gap-x-1 overflow-y-auto hidden-scrollbar bin-container"></div>
                    <div class="text-center mt-2 font-black text-slate-800 bg-white/60 rounded-xl py-1 text-xs shadow-sm">Count: <span class="bin-counter">0</span></div>
                `;
                binsWrapper.appendChild(bin);
            }
        }

        function startMatchTimer() {
            if (gameTimer) clearInterval(gameTimer);
            updateTimerDisplay();
            gameTimer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) endGame();
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const s = (timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }

        function startNewRound() {
            sourcePile.innerHTML = '';
            for (let i = 0; i < numGroupsSetting; i++) {
                binCubes[i] = [];
                const binEl = document.getElementById(`bin-${i}`);
                if (binEl) {
                    binEl.querySelector('.bin-container').innerHTML = '';
                    binEl.querySelector('.bin-counter').innerText = '0';
                }
            }
            answerInput.value = '';
            lastAutoBinIndex = 0;

            let possibleMultiples = [];
            for (let i = numGroupsSetting; i <= maxCubesSetting; i += numGroupsSetting) {
                possibleMultiples.push(i);
            }
            currentTotalCubes = possibleMultiples[Math.floor(Math.random() * possibleMultiples.length)];

            for (let i = 0; i < currentTotalCubes; i++) {
                const cube = document.createElement('div');
                cube.className = 'cube pop-in';
                cube.id = 'cube-' + Math.random().toString(36).substr(2, 9);
                cube.style.animationDelay = (i * 0.01) + 's';
                sourcePile.appendChild(cube);
            }

            updateUI();
        }

        function refreshBinDisplay(binIndex) {
            const binEl = document.getElementById(`bin-${binIndex}`);
            if (!binEl) return;
            const container = binEl.querySelector('.bin-container');
            const cubes = binCubes[binIndex];
            container.innerHTML = '';
            
            for (let i = 0; i < cubes.length; i += 10) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'ten-group pop-in';
                const slice = cubes.slice(i, i + 10);
                slice.forEach(cubeData => {
                    const cubeEl = document.createElement('div');
                    cubeEl.className = 'cube';
                    cubeEl.id = cubeData.id;
                    groupDiv.appendChild(cubeEl);
                });
                container.appendChild(groupDiv);
            }
            
            binEl.querySelector('.bin-counter').innerText = cubes.length;
            updateUI();
        }

        function updateUI() {
            // ƒê·∫øm s·ªë l∆∞·ª£ng con th·ª±c t·∫ø trong DOM ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªô ch√≠nh x√°c
            const count = sourcePile.querySelectorAll('.cube').length;
            cubesLeftDisplay.innerText = count;

            if (count === 0) {
                submitSection.style.opacity = "1";
                checkBtn.disabled = false;
            } else {
                submitSection.style.opacity = "0.3";
                checkBtn.disabled = true;
            }
        }

        function handlePointerDown(e) {
            // S·ª≠a l·ªói ƒë·ª©ng h√¨nh: ∆Øu ti√™n input
            if (e.target.tagName === 'INPUT') return;
            
            const cube = e.target.closest('.cube');
            if (!cube || isDragging || timeLeft <= 0) return;
            
            isPointerDown = true;
            draggedCubeId = cube.id;
            dragStartX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            dragStartY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
        }

        function handlePointerMove(e) {
            if (!isPointerDown) return;
            const x = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const y = e.clientY || (e.touches ? e.touches[0].clientY : 0);

            if (!isDragging && (Math.abs(x - dragStartX) > 5 || Math.abs(y - dragStartY) > 5)) {
                isDragging = true;
                const cube = document.getElementById(draggedCubeId);
                if (!cube) {
                    isPointerDown = false;
                    return;
                }
                const rect = cube.getBoundingClientRect();
                if (ghostCube) {
                    ghostCube.style.display = 'block';
                    ghostCube.style.left = rect.left + 'px';
                    ghostCube.style.top = rect.top + 'px';
                }
                cube.style.visibility = 'hidden';
                playSound('pop');
            }

            if (isDragging && ghostCube) {
                ghostCube.style.left = (x - 12) + 'px';
                ghostCube.style.top = (y - 12) + 'px';

                const zones = document.querySelectorAll('.drop-zone');
                currentTargetZone = null;
                zones.forEach(zone => {
                    const rect = zone.getBoundingClientRect();
                    if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                        zone.classList.add('active');
                        currentTargetZone = zone;
                    } else {
                        zone.classList.remove('active');
                    }
                });
            }
        }

        function handlePointerUp(e) {
            if (!isPointerDown) return;
            const cube = document.getElementById(draggedCubeId);
            
            if (!isDragging) {
                if (cube && cube.parentElement === sourcePile) {
                    fastDistribute(cube);
                }
            } else {
                if (cube) {
                    if (currentTargetZone) {
                        const binIndex = parseInt(currentTargetZone.id.split('-')[1]);
                        cube.remove();
                        addCubeToBin(draggedCubeId, binIndex);
                    } else {
                        cube.style.visibility = 'visible';
                    }
                }
            }
            
            if (ghostCube) ghostCube.style.display = 'none';
            document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('active'));
            isDragging = false; 
            isPointerDown = false; 
            draggedCubeId = null;
            currentTargetZone = null;
        }

        function fastDistribute(cubeEl) {
            const cubeId = cubeEl.id;
            cubeEl.remove();
            addCubeToBin(cubeId, lastAutoBinIndex);
            lastAutoBinIndex = (lastAutoBinIndex + 1) % numGroupsSetting;
            playSound('pop');
        }

        function addCubeToBin(id, binIndex) {
            binCubes[binIndex].push({ id });
            refreshBinDisplay(binIndex);
        }

        function checkSubmit() {
            if (timeLeft <= 0) return;
            const userAns = parseInt(answerInput.value);
            const correctAns = currentTotalCubes / numGroupsSetting;
            
            const firstBinCount = binCubes[0].length;
            const allBinsEqual = binCubes.every(bin => bin.length === firstBinCount);
            const matchesLogic = firstBinCount === correctAns;

            if (userAns === correctAns && allBinsEqual && matchesLogic) {
                playSound('correct');
                score++;
                scoreDisplay.innerText = score;
                startNewRound();
            } else {
                playSound('wrong');
                if (!allBinsEqual) {
                    document.querySelectorAll('.drop-zone').forEach(z => {
                        z.classList.add('wiggle');
                        setTimeout(() => z.classList.remove('wiggle'), 500);
                    });
                } else {
                    answerInput.classList.add('border-red-500', 'wiggle');
                    setTimeout(() => answerInput.classList.remove('border-red-500', 'wiggle'), 500);
                }
            }
        }

        function endGame() {
            clearInterval(gameTimer);
            const modal = document.getElementById('gameOverModal');
            modal.classList.remove('hidden');
            document.getElementById('finalScore').innerText = score;
            document.getElementById('solvedCount').innerText = score;
            requestAnimationFrame(animateFireworks);
        }

        function backToSetup() {
            document.getElementById('gameOverModal').classList.add('hidden');
            startScreen.classList.remove('hidden');
            fwParticles = [];
        }

        // --- Event Listeners ---
        window.onload = function() {
            initDOM();
            checkBtn.onclick = checkSubmit;
            
            window.addEventListener('mousedown', handlePointerDown);
            window.addEventListener('mousemove', handlePointerMove);
            window.addEventListener('mouseup', handlePointerUp);
            window.addEventListener('touchstart', handlePointerDown, { passive: false });
            window.addEventListener('touchmove', handlePointerMove, { passive: false });
            window.addEventListener('touchend', handlePointerUp);

            // Cho ph√©p nh·∫•n Enter ƒë·ªÉ submit
            answerInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !checkBtn.disabled) checkSubmit();
            });
        };

        // --- Fireworks Animation ---
        const fwCanvas = document.getElementById('fireworksCanvas');
        const fwCtx = fwCanvas.getContext('2d');
        let fwParticles = [];
        window.addEventListener('resize', () => { fwCanvas.width = window.innerWidth; fwCanvas.height = window.innerHeight; });
        fwCanvas.width = window.innerWidth; fwCanvas.height = window.innerHeight;

        function animateFireworks() {
            fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
            fwParticles.forEach((p, index) => {
                p.x += p.vx; p.y += p.vy; p.vy += 0.05; p.alpha -= 0.015;
                fwCtx.save(); fwCtx.globalAlpha = p.alpha; fwCtx.fillStyle = p.color; 
                fwCtx.beginPath(); fwCtx.arc(p.x, p.y, 3, 0, Math.PI * 2); fwCtx.fill(); fwCtx.restore();
                if (p.alpha <= 0) fwParticles.splice(index, 1);
            });
            if (Math.random() < 0.05 && fwParticles.length < 300) {
                 const x = Math.random() * fwCanvas.width;
                 const y = Math.random() * fwCanvas.height / 2;
                 const color = ['#f00','#0f0','#00f','#ff0','#f0f','#0ff'][Math.floor(Math.random()*6)];
                 for(let i=0;i<20;i++) fwParticles.push({x, y, vx: Math.cos(i)*Math.random()*4, vy: Math.sin(i)*Math.random()*4, color, alpha: 1});
            }
            if (fwParticles.length > 0 || !document.getElementById('gameOverModal').classList.contains('hidden')) {
                requestAnimationFrame(animateFireworks);
            }
        }

        document.getElementById('muteBtn').onclick = function() {
            isMuted = !isMuted;
            this.innerText = isMuted ? 'üîá' : 'üîä';
        };
    </script>
</body>
</html>

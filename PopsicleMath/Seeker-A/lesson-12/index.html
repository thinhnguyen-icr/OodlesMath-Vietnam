<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ladybug Number Bonds Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Varela Round', sans-serif;
            background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%);
            overflow: hidden;
            touch-action: none; /* Prevent scrolling on mobile */
            user-select: none;
        }

        .font-bubble { font-family: 'Fredoka One', cursive; }

        /* Ladybug Styling */
        .ladybug-body {
            background: #ff4757;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .wing-divider {
            position: absolute;
            left: 50%;
            top: 20%;
            bottom: 5%;
            width: 4px;
            background: rgba(0,0,0,0.3);
            transform: translateX(-50%);
            border-radius: 2px;
        }

        .dot {
            width: 40px; /* Reduced from 45px for better fit */
            height: 40px;
            background: #2f3542;
            border-radius: 50%;
            box-shadow: 2px 4px 8px rgba(0,0,0,0.3);
            position: absolute;
            transform: translate(-50%, -50%);
            z-index: 20;
            transition: transform 0.1s, top 0.3s ease-out, left 0.3s ease-out, width 0.3s, height 0.3s;
        }
        
        .dot.small {
            width: 32px; /* Adjusted small size */
            height: 32px;
        }
        
        .dot::after {
            content: '';
            position: absolute;
            top: 20%;
            left: 20%;
            width: 30%;
            height: 30%;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
        }

        /* Source Dot (in the tray) */
        .source-dot {
            width: 60px;
            height: 60px;
            background: #2f3542;
            border-radius: 50%;
            cursor: grab;
            display: inline-block;
            margin: 0 10px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .source-dot:active { cursor: grabbing; transform: scale(0.95); }

        /* Drop Zones */
        /* Heavily adjusted to define a strict "Safe Zone" inside the curve */
        .wing-zone {
            position: absolute;
            top: 25%; /* Pushed down to avoid top curve */
            width: 34%; /* Narrower to avoid side curves */
            height: 52%; /* Shorter to avoid bottom curve */
            /* border: 1px solid rgba(255,255,255,0.2); Debugging: shows safe zone */
            z-index: 10;
        }
        .left-wing { left: 12%; } /* Pushed in from edge */
        .right-wing { right: 12%; } /* Pushed in from edge */

        /* Animations */
        @keyframes pop {
            0% { transform: scale(0); }
            80% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes cheer {
            0%, 100% { transform: translateY(0) rotate(0); }
            25% { transform: translateY(-20px) rotate(-5deg); }
            75% { transform: translateY(-10px) rotate(5deg); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .animate-pop { animation: pop 0.4s ease-out forwards; }
        .animate-cheer { animation: cheer 0.6s ease-in-out; }
        .animate-shake { animation: shake 0.4s ease-in-out; }

        /* Progress Bar */
        .progress-pill {
            width: 12px;
            height: 12px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transition: all 0.3s;
        }
        .progress-pill.active { background: #ffeb3b; transform: scale(1.3); }

        #start-overlay {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-between py-4">

    <!-- Start Screen Overlay -->
    <div id="start-overlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-8 text-center">
        <h1 class="font-bubble text-5xl text-green-600 mb-4">Ladybug Math</h1>
        <div class="text-6xl mb-6">üêû</div>
        <p class="text-xl text-gray-600 mb-8">Make the wings equal the target number!</p>
        <button onclick="startGame()" class="bg-green-500 hover:bg-green-600 text-white font-bubble text-2xl px-8 py-4 rounded-full shadow-xl transition transform hover:scale-105 active:scale-95">
            Play Game ‚ñ∂
        </button>
    </div>

    <!-- Top Bar: Target & Progress -->
    <div class="w-full max-w-lg flex flex-col items-center z-10">
        <!-- Progress Dots -->
        <div class="flex gap-2 mb-2" id="progress-container">
            <!-- Generated via JS -->
        </div>

        <!-- Target Display -->
        <div class="relative bg-white/90 backdrop-blur rounded-3xl px-8 py-3 shadow-lg border-b-4 border-green-600 animate-bounce-slight">
            <h2 class="text-gray-500 text-lg uppercase tracking-wider font-bold text-center leading-none">Make</h2>
            <div class="text-6xl font-bubble text-green-600 leading-none" id="target-number">5</div>
        </div>
    </div>

    <!-- Game Area -->
    <div class="flex-grow flex items-center justify-center w-full relative">
        
        <!-- The Ladybug -->
        <div id="ladybug" class="ladybug-body relative w-[340px] h-[340px] md:w-[400px] md:h-[400px] rounded-full flex flex-col items-center">
            
            <!-- Head -->
            <div class="absolute -top-12 w-32 h-32 bg-gray-800 rounded-full z-0 flex justify-center items-start pt-4">
                <!-- Eyes -->
                <div class="flex gap-4 mt-4">
                    <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center">
                        <div class="w-3 h-3 bg-black rounded-full"></div>
                    </div>
                    <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center">
                        <div class="w-3 h-3 bg-black rounded-full"></div>
                    </div>
                </div>
                <!-- Antennae -->
                <div class="absolute -top-6 left-2 w-1 h-8 bg-black rotate-[-20deg]">
                    <div class="absolute -top-2 -left-1 w-3 h-3 bg-black rounded-full"></div>
                </div>
                <div class="absolute -top-6 right-2 w-1 h-8 bg-black rotate-[20deg]">
                    <div class="absolute -top-2 -left-1 w-3 h-3 bg-black rounded-full"></div>
                </div>
            </div>

            <!-- Body Divider -->
            <div class="wing-divider"></div>

            <!-- Left Wing (Pre-filled) -->
            <div id="left-wing" class="wing-zone left-wing"></div>

            <!-- Right Wing (Drop Target) -->
            <div id="right-wing" class="wing-zone right-wing"></div>
        </div>
    </div>

    <!-- Bottom Tray: Draggable Dots -->
    <div class="w-full bg-white/80 backdrop-blur-md h-32 rounded-t-3xl shadow-[0_-10px_30px_rgba(0,0,0,0.1)] z-20 flex flex-col items-center justify-center relative">
        <p class="absolute -top-5 bg-yellow-400 text-yellow-900 px-4 py-1 rounded-full font-bold text-sm shadow-md">Drag from here</p>
        <div class="flex items-center justify-center w-full" id="dot-tray">
            <div class="source-dot" id="drag-source"></div>
            <div class="source-dot" style="opacity: 0.5; transform: scale(0.8);"></div>
            <div class="source-dot" style="opacity: 0.3; transform: scale(0.6);"></div>
        </div>
    </div>

    <!-- Hidden audio helper -->
    <div id="audio-helper"></div>

<script>
    // --- Game Configuration (15 Questions) ---
    const levels = [
        { target: 5, prefilled: 2 },
        { target: 6, prefilled: 3 },
        { target: 5, prefilled: 1 },
        { target: 7, prefilled: 4 },
        { target: 8, prefilled: 4 },
        { target: 6, prefilled: 2 },
        { target: 9, prefilled: 5 },
        { target: 10, prefilled: 5 },
        { target: 7, prefilled: 2 },
        { target: 10, prefilled: 3 },
        // New Levels added below
        { target: 8, prefilled: 3 },
        { target: 9, prefilled: 2 },
        { target: 6, prefilled: 1 },
        { target: 7, prefilled: 3 },
        { target: 10, prefilled: 6 }
    ];

    let currentLevelIdx = 0;
    let currentDotsOnRight = 0;
    let audioContext = null;

    // --- Dot Patterns (Percentage Top, Left) ---
    // Refined for better spacing on the vertical wings
    const dotPatterns = {
        1: [{t:50, l:50}],
        2: [{t:25, l:50}, {t:75, l:50}],
        3: [{t:20, l:50}, {t:80, l:20}, {t:80, l:80}], // Triangle - wider base
        4: [{t:20, l:20}, {t:20, l:80}, {t:80, l:20}, {t:80, l:80}], // Square - pushed to corners
        5: [{t:15, l:15}, {t:15, l:85}, {t:50, l:50}, {t:85, l:15}, {t:85, l:85}], // Quincunx - wide
        6: [{t:15, l:20}, {t:15, l:80}, {t:50, l:20}, {t:50, l:80}, {t:85, l:20}, {t:85, l:80}], // 2x3 Grid - wide
        7: [{t:15, l:20}, {t:15, l:80}, {t:50, l:20}, {t:50, l:50}, {t:50, l:80}, {t:85, l:20}, {t:85, l:80}], // H-shape
        8: [{t:10, l:20}, {t:10, l:80}, {t:37, l:20}, {t:37, l:80}, {t:63, l:20}, {t:63, l:80}, {t:90, l:20}, {t:90, l:80}], // 2x4 Grid
        9: [{t:15, l:15}, {t:15, l:50}, {t:15, l:85}, {t:50, l:15}, {t:50, l:50}, {t:50, l:85}, {t:85, l:15}, {t:85, l:50}, {t:85, l:85}], // 3x3 Grid
        10: [{t:8, l:20}, {t:8, l:80}, {t:29, l:20}, {t:29, l:80}, {t:50, l:20}, {t:50, l:80}, {t:71, l:20}, {t:71, l:80}, {t:92, l:20}, {t:92, l:80}] // 2x5 Grid
    };

    // --- DOM Elements ---
    const targetDisplay = document.getElementById('target-number');
    const leftWing = document.getElementById('left-wing');
    const rightWing = document.getElementById('right-wing');
    const ladybug = document.getElementById('ladybug');
    const dragSource = document.getElementById('drag-source');
    const progressContainer = document.getElementById('progress-container');

    // --- Initialization ---
    function initProgress() {
        progressContainer.innerHTML = '';
        levels.forEach((_, idx) => {
            const pill = document.createElement('div');
            pill.className = `progress-pill ${idx === 0 ? 'active' : ''}`;
            pill.id = `pill-${idx}`;
            progressContainer.appendChild(pill);
        });
    }

    function startGame() {
        document.getElementById('start-overlay').style.display = 'none';
        
        // Init Audio Context for sound effects
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();

        initProgress();
        loadLevel(0);
    }

    function loadLevel(idx) {
        currentLevelIdx = idx;
        const level = levels[idx];
        currentDotsOnRight = 0;

        // Update UI
        targetDisplay.innerText = level.target;
        
        // Update Progress Bar
        document.querySelectorAll('.progress-pill').forEach((p, i) => {
            if (i === idx) p.classList.add('active');
            else p.classList.remove('active');
            if (i < idx) p.style.backgroundColor = '#4CAF50'; // Green for completed
        });

        // Clear Wings
        leftWing.innerHTML = '';
        rightWing.innerHTML = '';

        // Fill Left Wing (Pre-filled)
        for(let i=0; i<level.prefilled; i++) {
            createDot(leftWing, false);
        }

        // Voice Prompt
        speak(`Look at this wing. Drag more dots to make ${level.target}.`);
    }

    function repositionDots(container) {
        const dots = container.getElementsByClassName('dot');
        const count = dots.length;
        const pattern = dotPatterns[count] || dotPatterns[1]; // Fallback

        if (count > 0) {
            Array.from(dots).forEach((dot, index) => {
                // Shrink dots if crowded (8 or more)
                if (count >= 8) {
                    dot.classList.add('small');
                } else {
                    dot.classList.remove('small');
                }

                const pos = pattern[index] || {t: 50, l: 50}; 
                dot.style.top = pos.t + '%';
                dot.style.left = pos.l + '%';
            });
        }
    }

    function createDot(container, isAnimated) {
        const dot = document.createElement('div');
        dot.className = isAnimated ? 'dot animate-pop' : 'dot';
        
        // Initial random position to pop from (visual flair), then it snaps to grid
        if (isAnimated) {
            dot.style.top = '50%';
            dot.style.left = '50%';
        }
        
        container.appendChild(dot);
        repositionDots(container);
    }

    // --- Interaction Logic ---

    // Drag Setup
    let activeDrag = null;
    let touchOffset = { x: 0, y: 0 };

    function startDrag(e) {
        e.preventDefault();
        
        // Determine input coordinates
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;

        // Create a temporary flying dot
        activeDrag = document.createElement('div');
        activeDrag.className = 'dot';
        activeDrag.style.position = 'fixed';
        activeDrag.style.zIndex = 100;
        activeDrag.style.width = '60px'; // Slightly larger while dragging
        activeDrag.style.height = '60px';
        activeDrag.style.pointerEvents = 'none'; // Let clicks pass through to detect drop zones
        
        // Center it on finger/cursor
        activeDrag.style.left = clientX + 'px';
        activeDrag.style.top = clientY + 'px';
        
        document.body.appendChild(activeDrag);
        
        playTone('pop');

        document.addEventListener('mousemove', onDrag);
        document.addEventListener('touchmove', onDrag, {passive: false});
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
    }

    function onDrag(e) {
        if (!activeDrag) return;
        e.preventDefault();
        
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;

        activeDrag.style.left = clientX + 'px';
        activeDrag.style.top = clientY + 'px';
    }

    function endDrag(e) {
        if (!activeDrag) return;

        // Get drop coordinates
        // For touch, changedTouches gives the final position
        const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
        const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;

        // Check collision with Right Wing
        const rect = rightWing.getBoundingClientRect();
        
        // Simple bounding box check
        if (clientX >= rect.left && clientX <= rect.right &&
            clientY >= rect.top && clientY <= rect.bottom) {
            
            // Success Drop
            handleDropSuccess();
        } 

        // Cleanup
        activeDrag.remove();
        activeDrag = null;
        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('touchmove', onDrag);
        document.removeEventListener('mouseup', endDrag);
        document.removeEventListener('touchend', endDrag);
    }

    dragSource.addEventListener('mousedown', startDrag);
    dragSource.addEventListener('touchstart', startDrag, {passive: false});

    // --- Game Mechanics ---

    function handleDropSuccess() {
        createDot(rightWing, true); // Create dot on wing
        currentDotsOnRight++;
        playTone('drop');
        checkAnswer();
    }

    function checkAnswer() {
        const level = levels[currentLevelIdx];
        const currentTotal = level.prefilled + currentDotsOnRight;

        if (currentTotal === level.target) {
            // Correct!
            handleCorrect();
        } else if (currentTotal > level.target) {
            // Too many!
            handleIncorrect();
        }
        // If less, do nothing, keep playing
    }

    function handleCorrect() {
        playTone('success');
        ladybug.classList.add('animate-cheer');
        
        // confetti effect via simple DOM particles
        spawnConfetti();

        // Voice encouragement
        setTimeout(() => {
            speak("Great job!");
        }, 500);

        setTimeout(() => {
            ladybug.classList.remove('animate-cheer');
            
            if (currentLevelIdx < levels.length - 1) {
                loadLevel(currentLevelIdx + 1);
            } else {
                showWinScreen();
            }
        }, 2000);
    }

    function handleIncorrect() {
        playTone('error');
        ladybug.classList.add('animate-shake');
        
        // Remove the last added dot
        setTimeout(() => {
            if (rightWing.lastChild) {
                rightWing.lastChild.remove();
                currentDotsOnRight--;
                repositionDots(rightWing); // Re-distribute remaining dots evenly
            }
            ladybug.classList.remove('animate-shake');
            speak("Oops. Too many.");
        }, 500);
    }

    function showWinScreen() {
        const overlay = document.getElementById('start-overlay');
        overlay.style.display = 'flex';
        overlay.innerHTML = `
            <h1 class="font-bubble text-5xl text-yellow-500 mb-4">You Did It!</h1>
            <div class="text-6xl mb-6">üåü</div>
            <p class="text-xl text-gray-600 mb-8">You finished all 15 questions!</p>
            <button onclick="location.reload()" class="bg-blue-500 hover:bg-blue-600 text-white font-bubble text-2xl px-8 py-4 rounded-full shadow-xl">
                Play Again ‚Ü∫
            </button>
        `;
        playTone('win');
    }

    // --- Audio Utilities ---

    function speak(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9; // Slightly slower for kids
            utterance.pitch = 1.1; // Slightly higher/friendly
            window.speechSynthesis.speak(utterance);
        }
    }

    function playTone(type) {
        if (!audioContext) return;
        
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);

        const now = audioContext.currentTime;

        if (type === 'pop') {
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.exponentialRampToValueAtTime(600, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        }
        else if (type === 'drop') {
            osc.frequency.setValueAtTime(600, now);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        }
        else if (type === 'success') {
            // Chime
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(523.25, now); // C
            osc.frequency.setValueAtTime(659.25, now + 0.1); // E
            osc.frequency.setValueAtTime(783.99, now + 0.2); // G
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.6);
            osc.start(now);
            osc.stop(now + 0.6);
        }
        else if (type === 'error') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.linearRampToValueAtTime(100, now + 0.3);
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
        }
    }

    function spawnConfetti() {
        for(let i=0; i<30; i++) {
            const conf = document.createElement('div');
            conf.style.position = 'absolute';
            conf.style.left = '50%';
            conf.style.top = '50%';
            conf.style.width = '10px';
            conf.style.height = '10px';
            conf.style.backgroundColor = ['#ff0', '#f00', '#0f0', '#00f'][Math.floor(Math.random()*4)];
            conf.style.transition = 'all 1s ease-out';
            conf.style.zIndex = 100;
            document.body.appendChild(conf);

            // Animate out
            setTimeout(() => {
                const angle = Math.random() * Math.PI * 2;
                const dist = 200 + Math.random() * 100;
                conf.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px) rotate(${Math.random()*360}deg)`;
                conf.style.opacity = 0;
            }, 10);

            setTimeout(() => conf.remove(), 1000);
        }
    }
</script>
</body>
</html>
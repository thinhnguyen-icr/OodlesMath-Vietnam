<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../assets/brand.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Goat Bridge Battle: Math for Kids</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sky-blue: #a2d2ff;
            --grass-green: #7dc66d;
            --river-blue: #4db8ff;
            --wood-brown: #8d6e63;
            --p1-white: #ffffff;
            --p2-black: #3d3d3d;
            --flower-pink: #ffafcc;
            --flower-yellow: #ffea00;
        }

        /* NgƒÉn ch·∫∑n t∆∞∆°ng t√°c kh√¥ng mong mu·ªën tr√™n mobile */
        * { 
            box-sizing: border-box; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
            touch-action: manipulation;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Poppins', sans-serif;
            background-color: var(--sky-blue);
            height: 100dvh; 
            overflow: hidden;
            display: flex; flex-direction: column;
            color: #2c3e50;
        }

        #game-container {
            position: relative;
            width: 100%; max-width: 1200px;
            height: 100%; margin: 0 auto;
            display: flex; flex-direction: column;
            background: linear-gradient(to bottom, #d6eaff 0%, #a2d2ff 100%);
            box-shadow: 0 0 50px rgba(0,0,0,0.1);
        }

        /* --- HEADER UI --- */
        header {
            padding: 10px clamp(10px, 4vw, 25px);
            display: flex; 
            justify-content: flex-start; /* ƒêi·ªÉm s·ªë sang tr√°i */
            z-index: 100;
            flex-shrink: 0;
        }

        .stats-bar {
            background: rgba(255, 255, 255, 0.9);
            padding: 6px clamp(12px, 3vw, 20px); border-radius: 40px;
            font-weight: 700; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex; gap: clamp(10px, 3vw, 20px); border: 3px solid #ffafcc;
            font-size: clamp(0.7rem, 2vw, 0.9rem);
        }

        /* --- STAGE DESIGN --- */
        #main-stage {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .sun {
            position: absolute; top: 10px; left: 20px;
            width: clamp(35px, 10vw, 70px); height: clamp(35px, 10vw, 70px); 
            background: #ffea00;
            border-radius: 50%; box-shadow: 0 0 30px #ffea00;
            animation: pulse 4s infinite ease-in-out;
            z-index: 1;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        .cloud {
            position: absolute; background: white; border-radius: 50px;
            opacity: 0.9; animation: floatCloud linear infinite;
        }
        .cloud::before, .cloud::after {
            content: ''; position: absolute; background: white; border-radius: 50%;
        }
        .cloud::before { width: 60%; height: 120%; top: -50%; left: 15%; }
        .cloud::after { width: 50%; height: 100%; top: -40%; right: 15%; }

        .c1 { width: 80px; height: 25px; top: 15%; left: -150px; animation-duration: 28s; }
        .c2 { width: 110px; height: 35px; top: 25%; left: -200px; animation-duration: 38s; animation-delay: 6s; }
        @keyframes floatCloud { to { left: 110%; } }

        .land-bank {
            position: absolute; bottom: 0; width: 25%; height: 42%;
            background: var(--grass-green); z-index: 5;
            border-top: 8px solid #5da14d;
        }
        .left-bank { left: 0; border-radius: 0 100px 0 0; }
        .right-bank { right: 0; border-radius: 100px 0 0 0; }

        .flower {
            position: absolute; z-index: 6; font-size: clamp(14px, 3vw, 18px);
            animation: flowerShake 3s ease-in-out infinite;
        }
        @keyframes flowerShake { 0%, 100% { transform: rotate(-8deg); } 50% { transform: rotate(8deg); } }

        .river {
            position: absolute; bottom: 0; left: 10%; right: 10%; height: 35%;
            background: var(--river-blue); overflow: hidden; z-index: 1;
        }
        .wave {
            position: absolute; width: 200%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 100'%3E%3Cpath d='M0,50 Q250,0 500,50 T1000,50 V100 H0 Z' fill='rgba(255,255,255,0.2)'/%3E%3C/svg%3E");
            background-repeat: repeat-x;
            animation: waveFlow 6s linear infinite;
        }
        @keyframes waveFlow { from { transform: translateX(0); } to { transform: translateX(-50%); } }

        .bridge-container {
            position: absolute; bottom: 33%; left: 0; width: 100%; height: clamp(60px, 12vh, 100px);
            z-index: 10; pointer-events: none;
        }
        .bridge-svg { width: 100%; height: 100%; filter: drop-shadow(0 8px 4px rgba(0,0,0,0.15)); }

        /* --- CHARACTERS --- */
        .goat {
            position: absolute; bottom: 41%; 
            width: clamp(90px, 18vw, 140px); 
            height: clamp(80px, 16vh, 130px);
            z-index: 25; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; align-items: center;
        }
        .goat-svg { width: 100%; height: 100%; }
        
        #p1-goat { left: 34%; }
        #p2-goat { right: 34%; }

        .croc {
            position: absolute; bottom: -180px; left: 50%;
            transform: translateX(-50%); 
            width: clamp(160px, 30vw, 250px); 
            height: clamp(80px, 15vh, 130px);
            transition: bottom 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            z-index: 15;
        }

        /* --- MATH AREA (SMALLER, HIGHER, FIXED TOP BORDER) --- */
        #problem-container {
            position: absolute; 
            top: 10px; /* Di chuy·ªÉn l√™n tr√™n v√† ƒë·∫£m b·∫£o vi·ªÅn kh√¥ng b·ªã khu·∫•t */
            width: 100%;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: clamp(6px, 1.5vw, 12px); 
            z-index: 50;
        }

        #equation-box {
            display: inline-block; 
            padding: 6px clamp(12px, 3vw, 25px); /* Thu g·ªçn padding */
            background: white; border-radius: 40px;
            box-shadow: 0 4px 0 #ffc8dd;
            font-size: clamp(0.9rem, 3.5vw, 1.3rem); /* Ch·ªØ nh·ªè l·∫°i */
            font-weight: 700; color: #2c3e50;
            border: 3px solid #ffafcc;
            animation: bounceIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* ICON LOA ƒê·∫∏P H∆†N */
        .speaker-btn {
            width: clamp(28px, 6vw, 38px); 
            height: clamp(28px, 6vw, 38px);
            border-radius: 50%;
            background: linear-gradient(145deg, #ffb366, #ff9f43);
            border: 2px solid white;
            box-shadow: 0 3px 0 #e67e22; 
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            transition: transform 0.1s, box-shadow 0.1s;
            flex-shrink: 0;
        }
        .speaker-btn:active { transform: translateY(2px); box-shadow: 0 1px 0 #e67e22; }
        .speaker-btn svg { width: 60%; height: 60%; fill: white; }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* --- CONTROLS --- */
        .controls {
            padding: 10px clamp(10px, 4vw, 30px);
            display: flex; justify-content: space-between;
            background: white; border-top: 5px solid #ffc8dd; z-index: 100;
            flex-shrink: 0;
        }

        .player-panel { display: flex; flex-direction: column; gap: clamp(10px, 2vh, 18px); align-items: center; flex: 1; }
        
        .ans-btn {
            width: clamp(90px, 30vw, 140px); height: clamp(60px, 10vh, 85px); 
            border-radius: 25px;
            border: none; background: #fff; font-family: 'Poppins', sans-serif;
            font-size: clamp(1.5rem, 7vw, 2.4rem); font-weight: 700; cursor: pointer;
            box-shadow: 0 8px 0 #ffc8dd; transition: all 0.1s;
            color: #2c3e50; border: 4px solid #ffafcc;
            background-image: radial-gradient(circle at top left, #fff, #fff5f8);
        }
        .ans-btn:active { transform: translateY(5px); box-shadow: 0 3px 0 #ffc8dd; }

        .player-label {
            font-size: clamp(0.65rem, 2vw, 0.85rem); font-weight: 700;
            white-space: nowrap;
            margin-bottom: -5px;
        }

        /* --- OVERLAYS --- */
        .overlay {
            position: absolute; inset: 0; background: rgba(162, 210, 255, 0.95);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; padding: 20px; backdrop-filter: blur(8px);
        }

        .modal {
            background: white; padding: clamp(20px, 5vw, 40px); border-radius: 40px;
            text-align: center; max-width: 500px; width: 100%;
            box-shadow: 0 15px 0 #ffc8dd;
            border: 10px solid #ffafcc;
        }

        .mode-btn {
            display: block; width: 100%; padding: 15px; margin: 12px 0;
            border-radius: 25px; border: none; font-size: clamp(1rem, 4vw, 1.6rem);
            font-weight: 700; cursor: pointer; font-family: 'Poppins';
            transition: transform 0.2s; color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .mode-cpu { background: #3498db; box-shadow: 0 10px 0 #2980b9; }
        .mode-pvp { background: #ffafcc; box-shadow: 0 10px 0 #ff85a1; }

        #feedback-pop {
            position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%);
            font-size: clamp(3rem, 12vw, 5rem); font-weight: 700; color: #ffea00;
            text-shadow: 4px 4px 0px rgba(0,0,0,0.1);
            z-index: 200; pointer-events: none; opacity: 0;
        }

        #fireworks-canvas { position: absolute; inset: 0; pointer-events: none; z-index: 1100; }

        .hidden { display: none !important; }

        /* Animation States */
        .huc-left { animation: hucLeft 0.5s ease-out; }
        .huc-right { animation: hucRight 0.5s ease-out; }
        @keyframes hucLeft { 0%, 100% { left: 34%; } 20% { left: 30%; } 50% { left: 45%; } }
        @keyframes hucRight { 0%, 100% { right: 34%; } 20% { right: 30%; } 50% { right: 45%; } }

        .fall-p1 { animation: fallP1 1.2s forwards; }
        .fall-p2 { animation: fallP2 1.2s forwards; }
        @keyframes fallP1 { 100% { transform: translate(-80px, 350px) rotate(-180deg); opacity: 0; } }
        @keyframes fallP2 { 100% { transform: translate(80px, 350px) rotate(180deg); opacity: 0; } }

        @media (orientation: portrait) {
            #p1-goat { left: 30%; }
            #p2-goat { right: 30%; }
            .goat { width: clamp(80px, 22vw, 110px); }
            #equation-box { font-size: 1rem; padding: 4px 18px; }
            .player-panel { gap: 12px; }
        }
    </style>
</head>
<body>
<img src="../assets/logo-oodles-math.png" class="oodles-logo">
<div id="game-container">
    <canvas id="fireworks-canvas"></canvas>

    <header>
        <!-- Kh·ªëi t√≠nh ƒëi·ªÉm di chuy·ªÉn sang tr√°i -->
        <div class="stats-bar">
            <div id="question-counter">Question: 1/20</div>
            <div>Stars: <span id="win-count">0</span> ‚≠ê</div>
        </div>
    </header>

    <div id="main-stage">
        <div class="sun"></div>
        <div class="cloud c1"></div>
        <div class="cloud c2"></div>
        
        <div class="flower" style="bottom: 43%; left: 5%;">üå∏</div>
        <div class="flower" style="bottom: 45%; left: 10%;">üåº</div>
        <div class="flower" style="bottom: 43%; right: 5%;">üå∏</div>
        <div class="flower" style="bottom: 45%; right: 10%;">üåª</div>

        <div class="land-bank left-bank"></div>
        <div class="land-bank right-bank"></div>
        
        <div class="river"><div class="wave"></div></div>

        <div class="bridge-container">
            <svg class="bridge-svg" viewBox="0 0 1000 120" preserveAspectRatio="none">
                <path d="M0,120 Q500,0 1000,120" fill="none" stroke="#5d4037" stroke-width="20" stroke-linecap="round" />
                <path d="M0,120 Q500,0 1000,120" fill="none" stroke="#8d6e63" stroke-width="14" stroke-dasharray="35 15" />
            </svg>
        </div>

        <!-- Kh·ªëi ph√©p t√≠nh: Nh·ªè h∆°n & Di chuy·ªÉn cao h∆°n -->
        <div id="problem-container">
            <div id="equation-box">? + ? = ?</div>
            <div class="speaker-btn" onclick="speakMath()" title="Listen">
                <svg viewBox="0 0 24 24">
                    <path d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.85 14,18.71V20.77C18,19.86 21,16.28 21,12C21,7.72 18,4.14 14,3.23M16.5,12C16.5,10.23 15.48,8.71 14,7.97V16.02C15.48,15.29 16.5,13.77 16.5,12M3,9V15H7L12,20V4L7,9H3Z"/>
                </svg>
            </div>
        </div>

        <!-- Goats -->
        <div id="p1-goat" class="goat">
            <svg class="goat-svg" viewBox="0 0 120 120">
                <defs>
                    <linearGradient id="gradGoat1" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#ffffff" />
                        <stop offset="100%" style="stop-color:#f0f0f0" />
                    </linearGradient>
                </defs>
                <g>
                    <path d="M25,55 Q20,60 25,65 L25,85 Q25,95 35,95 L75,95 Q85,95 85,85 L85,65 Q90,60 85,55 Z" fill="url(#gradGoat1)" stroke="#ccc" stroke-width="2"/>
                    <circle cx="20" cy="60" r="10" fill="white" stroke="#ccc" stroke-width="2"/>
                    <rect x="35" y="90" width="8" height="18" rx="4" fill="#ddd"/>
                    <rect x="70" y="90" width="8" height="18" rx="4" fill="#ddd"/>
                    <circle cx="85" cy="50" r="24" fill="white" stroke="#ccc" stroke-width="2"/>
                    <path d="M72,32 Q78,5 95,25" fill="none" stroke="#ffcc00" stroke-width="7" stroke-linecap="round"/>
                    <circle cx="98" cy="48" r="4" fill="#333"/>
                    <circle cx="105" cy="58" r="8" fill="#ffafcc" opacity="0.5"/>
                    <path d="M105,65 Q98,72 90,65" fill="none" stroke="#333" stroke-width="2.5" stroke-linecap="round"/>
                    <ellipse cx="65" cy="45" rx="6" ry="12" fill="#ffc8dd" transform="rotate(-35 65 45)"/>
                    <circle cx="85" cy="78" r="7" fill="#ffd700" stroke="#b8860b" stroke-width="1"/>
                </g>
            </svg>
        </div>

        <div id="p2-goat" class="goat">
            <svg class="goat-svg" viewBox="0 0 120 120">
                <defs>
                    <linearGradient id="gradGoat2" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#555" />
                        <stop offset="100%" style="stop-color:#333" />
                    </linearGradient>
                </defs>
                <g transform="scale(-1, 1) translate(-120, 0)">
                    <path d="M25,55 Q20,60 25,65 L25,85 Q25,95 35,95 L75,95 Q85,95 85,85 L85,65 Q90,60 85,55 Z" fill="url(#gradGoat2)" stroke="#111" stroke-width="2"/>
                    <circle cx="20" cy="60" r="10" fill="#444" stroke="#111" stroke-width="2"/>
                    <rect x="35" y="90" width="8" height="18" rx="4" fill="#111"/>
                    <rect x="70" y="90" width="8" height="18" rx="4" fill="#111"/>
                    <circle cx="85" cy="50" r="24" fill="url(#gradGoat2)" stroke="#111" stroke-width="2"/>
                    <path d="M72,32 Q78,5 95,25" fill="none" stroke="#a0a0a0" stroke-width="7" stroke-linecap="round"/>
                    <circle cx="98" cy="48" r="4" fill="#fff"/>
                    <circle cx="105" cy="58" r="8" fill="#ffafcc" opacity="0.3"/>
                    <path d="M105,65 Q98,72 90,65" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/>
                    <ellipse cx="65" cy="45" rx="6" ry="12" fill="#222" transform="rotate(-35 65 45)"/>
                    <circle cx="85" cy="78" r="7" fill="#3498db" stroke="#1c5d8a" stroke-width="1"/>
                </g>
            </svg>
        </div>

        <!-- Crocodile -->
        <div id="croc-obj" class="croc">
            <svg viewBox="0 0 280 140" width="100%" height="100%">
                <defs>
                    <linearGradient id="gradCrocBody" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#9ff0a5" />
                        <stop offset="100%" style="stop-color:#6bbd5a" />
                    </linearGradient>
                </defs>
                <ellipse cx="140" cy="115" rx="110" ry="15" fill="rgba(0,0,0,0.1)"/>
                <path d="M30,85 Q140,30 250,85 L255,90 Q140,120 25,90 Z" fill="url(#gradCrocBody)" stroke="#4a8f3b" stroke-width="4"/>
                <path d="M65,65 L80,48 L95,65 M120,60 L135,43 L150,60 M175,60 L190,43 L205,60" fill="none" stroke="#4a8f3b" stroke-width="5" stroke-linecap="round"/>
                <circle cx="205" cy="55" r="20" fill="white" stroke="#4a8f3b" stroke-width="3"/>
                <circle cx="210" cy="55" r="10" fill="black" />
                <circle cx="165" cy="55" r="20" fill="white" stroke="#4a8f3b" stroke-width="3"/>
                <circle cx="170" cy="55" r="10" fill="black" />
                <circle cx="230" cy="85" r="14" fill="#ffafcc" opacity="0.6" />
                <circle cx="145" cy="85" r="14" fill="#ffafcc" opacity="0.6" />
                <path d="M155,100 Q195,115 240,95" fill="none" stroke="#4a8f3b" stroke-width="5" stroke-linecap="round"/>
                <circle cx="245" cy="90" r="3" fill="#4a8f3b" />
            </svg>
        </div>

        <div id="feedback-pop">YAY!</div>
    </div>

    <!-- UI CONTROLS (WIDER GAP) -->
    <div class="controls">
        <div class="player-panel">
            <div class="player-label" style="color: #3498db;">Player 1 (Keys: A, S)</div>
            <button id="p1-opt1" class="ans-btn" onclick="handleInput(1, 0)" style="border-color:#3498db; box-shadow:0 8px 0 #2980b9;">?</button>
            <button id="p1-opt2" class="ans-btn" onclick="handleInput(1, 1)" style="border-color:#3498db; box-shadow:0 8px 0 #2980b9;">?</button>
        </div>

        <div id="p2-controls" class="player-panel">
            <div id="p2-label" class="player-label" style="color: #3d2b1f;">Player 2 (Keys: K, L)</div>
            <button id="p2-opt1" class="ans-btn" onclick="handleInput(2, 0)" style="border-color:#e74c3c; box-shadow:0 10px 0 #c0392b;">?</button>
            <button id="p2-opt2" class="ans-btn" onclick="handleInput(2, 1)" style="border-color:#e74c3c; box-shadow:0 10px 0 #c0392b;">?</button>
        </div>
    </div>

    <!-- OVERLAYS -->
    <div id="menu-overlay" class="overlay">
        <div class="modal">
            <h1 style="margin: 0; color: #2c3e50; font-size: clamp(1.5rem, 5vw, 2.2rem);">üêê GOAT PARTY</h1>
            <p style="font-size: clamp(0.9rem, 3vw, 1.1rem); color: #7f8c8d; margin-bottom: 20px;">Solve magic math to win the bridge battle!</p>
            <button class="mode-btn mode-cpu" onclick="initGame('CPU')">PLAY VS COMPUTER</button>
            <button class="mode-btn mode-pvp" onclick="initGame('PVP')">TWO PLAYERS (PvP)</button>
        </div>
    </div>

    <div id="end-overlay" class="overlay hidden">
        <div class="modal">
            <h1 id="end-title" style="font-size: clamp(1.8rem, 8vw, 2.8rem); margin: 0; color: #7dc66d;">VICTORY!</h1>
            <p id="end-score" style="font-size: clamp(1rem, 4vw, 1.6rem); margin: 20px 0; font-weight: 700;"></p>
            <button class="mode-btn mode-cpu" onclick="location.reload()">PLAY AGAIN</button>
        </div>
    </div>
</div>

<script>
    /** --- TR·∫†NG TH√ÅI GAME --- **/
    const state = {
        mode: 'CPU',
        currentQ: 1,
        totalQ: 20,
        scoreP1: 0,
        scoreP2: 0,
        correct: 0,
        numA: 0,
        numB: 0,
        options: [],
        locked: false,
    };

    /** --- ƒê·ªåC PH√âP TO√ÅN (TTS) --- **/
    function speakMath() {
        if (!state.numA || !state.numB) return;
        const msg = new SpeechSynthesisUtterance(`${state.numA} plus ${state.numB}`);
        msg.lang = 'en-US';
        msg.rate = 0.8;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(msg);
    }

    /** --- √ÇM THANH HI·ªÜU ·ª®NG (Web Audio API) --- **/
    let audioCtx = null;
    function initAudio() { 
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); 
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }
    function playSound(type) {
        if(!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if(type === 'win') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(523, now);
            osc.frequency.exponentialRampToValueAtTime(1046, now + 0.3);
            gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
        } else if(type === 'lose') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now);
            osc.frequency.linearRampToValueAtTime(80, now + 0.4);
            gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
        } else if(type === 'splash') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(100, now);
            gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
        }
        osc.start(); osc.stop(now + 0.6);
    }

    /** --- LOGIC GAME --- **/
    function initGame(mode) {
        initAudio();
        state.mode = mode;
        document.getElementById('menu-overlay').classList.add('hidden');
        if(mode === 'CPU') {
            document.getElementById('p2-label').innerText = "COMPUTER";
            document.getElementById('p2-opt1').style.opacity = '0.4';
            document.getElementById('p2-opt2').style.opacity = '0.4';
        }
        newRound();
    }

    function generateMath() {
        const sum = Math.floor(Math.random() * 11) + 10;
        state.numA = Math.floor(Math.random() * (sum - 1)) + 1;
        state.numB = sum - state.numA;

        state.correct = sum;
        let dist;
        do { 
            dist = sum + (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random() * 2) + 1);
        } while (dist < 5 || dist > 25 || dist === sum);
        state.options = Math.random() > 0.5 ? [sum, dist] : [dist, sum];

        const box = document.getElementById('equation-box');
        box.innerText = `${state.numA} + ${state.numB} = ?`;
        box.style.animation = 'none';
        void box.offsetWidth; 
        box.style.animation = 'bounceIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)';

        document.getElementById('p1-opt1').innerText = state.options[0];
        document.getElementById('p1-opt2').innerText = state.options[1];
        document.getElementById('p2-opt1').innerText = state.options[0];
        document.getElementById('p2-opt2').innerText = state.options[1];
    }

    function newRound() {
        if(state.currentQ > state.totalQ) return endGame();
        state.locked = false;
        document.getElementById('question-counter').innerText = `Question: ${state.currentQ}/${state.totalQ}`;
        const p1 = document.getElementById('p1-goat'), p2 = document.getElementById('p2-goat');
        p1.className = 'goat'; p2.className = 'goat';
        p1.style.opacity = '1'; p2.style.opacity = '1';
        document.getElementById('croc-obj').style.bottom = '-180px';
        generateMath();

        if(state.mode === 'CPU') {
            const delay = 5000 + Math.random() * 3000;
            state.cpuTimer = setTimeout(() => {
                if(!state.locked) handleInput(2, state.options.indexOf(state.correct));
            }, delay);
        }
    }

    function handleInput(player, index) {
        if(state.locked) return;
        state.locked = true;
        clearTimeout(state.cpuTimer);
        const correct = (state.options[index] === state.correct);
        if(correct) handleWin(player);
        else handleLose(player);
    }

    function handleWin(winner) {
        playSound('win');
        const fb = document.getElementById('feedback-pop');
        fb.innerText = "YAY!"; fb.style.opacity = '1';
        const p1 = document.getElementById('p1-goat'), p2 = document.getElementById('p2-goat');
        if(winner === 1) {
            state.scoreP1++;
            p1.classList.add('huc-left');
            setTimeout(() => { p2.classList.add('fall-p2'); playSound('splash'); showCroc(); }, 350);
        } else {
            state.scoreP2++;
            p2.classList.add('huc-right');
            setTimeout(() => { p1.classList.add('fall-p1'); playSound('splash'); showCroc(); }, 350);
        }
        updateUI();
        finishRound();
    }

    function handleLose(loser) {
        playSound('lose');
        const fb = document.getElementById('feedback-pop');
        fb.innerText = "OOPS!"; fb.style.opacity = '1';
        const p1 = document.getElementById('p1-goat'), p2 = document.getElementById('p2-goat');
        if(loser === 1) p1.classList.add('fall-p1');
        else p2.classList.add('fall-p2');
        playSound('splash'); showCroc();
        finishRound();
    }

    function showCroc() { document.getElementById('croc-obj').style.bottom = '5%'; }
    function updateUI() { document.getElementById('win-count').innerText = state.scoreP1; }

    function finishRound() {
        setTimeout(() => {
            document.getElementById('feedback-pop').style.opacity = '0';
            state.currentQ++;
            newRound();
        }, 2200);
    }

    function endGame() {
        const endOverlay = document.getElementById('end-overlay');
        endOverlay.classList.remove('hidden');
        const scoreText = document.getElementById('end-score');
        if(state.mode === 'CPU') {
            document.getElementById('end-title').innerText = state.scoreP1 > state.scoreP2 ? "VICTORY!" : "CPU WON!";
            scoreText.innerText = `You earned ${state.scoreP1} stars!`;
        } else {
            document.getElementById('end-title').innerText = state.scoreP1 > state.scoreP2 ? "WHITE WINS!" : "BLACK WINS!";
            scoreText.innerText = `White: ${state.scoreP1} - Black: ${state.scoreP2}`;
        }
        startFireworks();
    }

    /** --- FIREWORKS LOGIC --- **/
    const canvas = document.getElementById('fireworks-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y; this.color = color;
            this.vel = { x: (Math.random() - 0.5) * 8, y: (Math.random() - 0.5) * 10 - 2 };
            this.alpha = 1;
            this.friction = 0.96;
            this.gravity = 0.08;
            this.sparkle = Math.random() > 0.5;
        }
        update() { 
            this.vel.x *= this.friction;
            this.vel.y *= this.friction;
            this.vel.y += this.gravity;
            this.x += this.vel.x; 
            this.y += this.vel.y; 
            this.alpha -= 0.012; 
        }
        draw() { 
            ctx.globalAlpha = this.alpha;
            ctx.beginPath(); 
            ctx.arc(this.x, this.y, this.sparkle ? 3 : 2, 0, Math.PI*2); 
            ctx.fillStyle = this.color; 
            ctx.shadowBlur = this.sparkle ? 15 : 5;
            ctx.shadowColor = this.color;
            ctx.fill(); 
        }
    }

    function startFireworks() {
        const endOverlay = document.getElementById('end-overlay');
        const fireworksInterval = setInterval(() => {
            if (!endOverlay.classList.contains('hidden')) {
                const color = `hsl(${Math.random()*360}, 100%, 65%)`;
                const x = Math.random()*canvas.width, y = Math.random()*canvas.height*0.5;
                for(let i=0; i<45; i++) particles.push(new Particle(x, y, color));
            } else {
                clearInterval(fireworksInterval);
            }
        }, 600);

        function anim() {
            if (endOverlay.classList.contains('hidden')) {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                return;
            }
            ctx.fillStyle = 'rgba(162, 210, 255, 0.2)'; 
            ctx.clearRect(0,0,canvas.width,canvas.height);
            particles = particles.filter(p => p.alpha > 0);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(anim);
        }
        anim();
    }

    window.addEventListener('keydown', (e) => {
        if(state.locked) return;
        if(e.code === 'KeyA') handleInput(1, 0);
        if(e.code === 'KeyS') handleInput(1, 1);
        if(state.mode === 'PVP') {
            if(e.code === 'KeyK') handleInput(2, 0);
            if(e.code === 'KeyL') handleInput(2, 1);
        }
    });
</script>
</body>
</html>

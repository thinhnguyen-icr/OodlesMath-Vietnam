<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../assets/brand.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ordinal Numbers Race (1st‚Äì10th)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Import font Poppins */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap');

        :root {
            --primary: #FF4757;
            --secondary: #2ED573;
            --accent: #FFA502;
            --info: #1E90FF;
            --bg-dots: #dfe4ea;
            --pink-light: #FFB6C1; /* M√†u h·ªìng ph·∫•n */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
            background-image: radial-gradient(var(--bg-dots) 15%, transparent 16%), radial-gradient(var(--bg-dots) 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            touch-action: manipulation;
            height: 100dvh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            overflow: hidden;
        }

        .game-card {
            box-shadow: 0 12px 0px rgba(0,0,0,0.1);
        }

        .btn-bounce:active {
            transform: scale(0.95);
        }

        /* Hi·ªáu ·ª©ng bong b√≥ng */
        .balloon {
            position: relative;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .balloon::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 12px solid currentColor;
            filter: brightness(0.9);
        }

        /* Animations */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .animate-pop { animation: pop 0.4s ease-out; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-2deg); }
            75% { transform: translateX(5px) rotate(2deg); }
        }
        .animate-shake { animation: shake 0.3s ease-in-out; }

        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <img src="../assets/logo-oodles-math.png" class="oodles-logo">
    <!-- Container ƒë∆∞·ª£c t·ªëi ∆∞u h√≥a chi·ªÅu cao dH ƒë·ªÉ fit m√†n h√¨nh ƒëi·ªán tho·∫°i -->
    <div id="game-container" class="w-full max-w-2xl bg-white sm:rounded-[50px] border-y-[6px] sm:border-[10px] border-orange-400 overflow-hidden relative flex flex-col h-full sm:h-[95dvh] game-card">
        
        <!-- Header: Thu g·ªçn padding tr√™n mobile -->
        <header class="bg-orange-400 p-3 sm:p-5 flex justify-between items-center text-white shrink-0">
            <div id="level-indicator" class="font-bold text-base sm:text-xl">Level: 1</div>
            <h1 class="font-extrabold text-lg sm:text-2xl tracking-wide">Ordinal Race üèÜ</h1>
            <div id="score-board" class="bg-white text-orange-500 px-3 py-1 sm:px-5 sm:py-2 rounded-full font-bold shadow-inner text-sm sm:text-lg">
                Score: 0
            </div>
        </header>

        <!-- Main Screen Area -->
        <main class="flex-grow relative p-4 sm:p-10 flex flex-col items-center justify-center overflow-hidden">
            
            <!-- M√ÄN H√åNH B·∫ÆT ƒê·∫¶U -->
            <section id="start-screen" class="screen space-y-4 sm:space-y-8">
                <div class="text-7xl sm:text-9xl animate-bounce">üèéÔ∏è</div>
                <h2 class="text-3xl sm:text-5xl font-extrabold text-red-500 leading-tight text-center">Ordinal Numbers<br>Race</h2>
                <p class="text-gray-500 text-base sm:text-xl bg-gray-100 px-6 py-2 sm:px-8 sm:py-3 rounded-full font-semibold">Master 1st to 10th!</p>
                <button onclick="startLevel(1)" class="bg-red-500 hover:bg-red-600 text-white text-2xl sm:text-4xl font-bold py-3 px-10 sm:py-5 sm:px-16 rounded-full shadow-[0_6px_0_#c42b3a] btn-bounce transition-all">
                    START ‚ñ∂
                </button>
            </section>

            <!-- LEVEL 1: BALLOONS -->
            <section id="level-1" class="screen hidden">
                <h3 class="text-gray-600 mb-3 sm:mb-6 text-lg sm:text-2xl font-bold text-center">Which balloon matches?</h3>
                <div class="bg-blue-50 w-full p-4 sm:p-6 rounded-[30px] sm:rounded-[40px] mb-4 sm:mb-8 flex items-center justify-between border-2 sm:border-4 border-blue-100 shadow-sm">
                    <div id="l1-prompt" class="text-3xl sm:text-5xl font-black text-blue-600">First</div>
                    <button id="l1-audio-btn" class="bg-yellow-400 p-3 sm:p-4 rounded-full shadow-lg btn-bounce text-xl sm:text-2xl">üîä</button>
                </div>
                <div id="l1-grid" class="grid grid-cols-2 gap-4 sm:gap-6 w-full max-w-lg">
                    <!-- Bong b√≥ng JS -->
                </div>
            </section>

            <!-- LEVEL 2: MATCHING -->
            <section id="level-2" class="screen hidden">
                <h3 class="text-gray-600 text-center mb-2 sm:mb-4 text-lg sm:text-2xl font-bold">Match Word & Number</h3>
                <p class="text-center text-sm sm:text-lg text-gray-400 mb-3 sm:mb-6 italic font-medium">Connect the pairs!</p>
                <div class="flex gap-3 sm:gap-6 w-full h-full max-h-[60dvh] sm:max-h-none">
                    <div id="l2-words" class="flex-1 flex flex-col gap-2 sm:gap-3 overflow-y-auto no-scrollbar"></div>
                    <div id="l2-nums" class="flex-1 flex flex-col gap-2 sm:gap-3 overflow-y-auto no-scrollbar"></div>
                </div>
            </section>

            <!-- LEVEL 3: LINE POSITION -->
            <section id="level-3" class="screen hidden">
                <div class="flex items-center gap-2 sm:gap-4 mb-4 sm:mb-8 bg-red-50 p-3 sm:p-6 rounded-[30px] sm:rounded-[40px] border-2 sm:border-4 border-red-100 w-full shadow-sm">
                    <h3 id="l3-question" class="flex-grow text-lg sm:text-2xl leading-tight font-black text-red-600 text-center">Who is in the 5th place?</h3>
                    <button id="l3-audio-btn" class="bg-yellow-400 p-2 sm:p-4 rounded-full shadow-lg btn-bounce shrink-0 text-lg sm:text-xl">üîä</button>
                </div>

                <div class="w-full py-4 sm:py-6 bg-slate-50 rounded-[25px] sm:rounded-[35px] border-2 sm:border-4 border-slate-100 shadow-inner flex flex-col items-center mb-4 sm:mb-8 overflow-hidden">
                    <div id="l3-line" class="flex px-1 sm:px-2 gap-1 sm:gap-1.5 items-center w-full justify-center">
                        <div class="bg-gray-800 text-white p-1 rounded font-bold text-[8px] sm:text-[10px] uppercase [writing-mode:vertical-lr] rotate-180">START</div>
                        <!-- Nh√¢n v·∫≠t JS -->
                    </div>
                </div>

                <div id="l3-options" class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4 w-full">
                    <!-- N√∫t ƒë√°p √°n JS -->
                </div>
                <p class="mt-4 sm:mt-8 text-gray-400 text-xs sm:text-sm font-medium animate-pulse">Count carefully from the START!</p>
            </section>

            <!-- BONUS SCREEN -->
            <section id="bonus-screen" class="screen hidden space-y-4 sm:space-y-8">
                <h2 class="text-3xl sm:text-5xl font-black text-yellow-500">BONUS ROUND!</h2>
                <p class="text-lg sm:text-2xl text-gray-600 font-bold">Pick a mystery box!</p>
                <div id="gift-container" class="flex gap-4 sm:gap-6"></div>
                <div id="bonus-reward-display" class="h-16 sm:h-24 flex items-center justify-center"></div>
                <button id="bonus-next-btn" onclick="nextLevelFromBonus()" class="hidden bg-blue-500 text-white py-3 px-8 sm:py-4 sm:px-12 rounded-full text-xl sm:text-2xl font-bold shadow-xl btn-bounce">Next Level ‚û°Ô∏è</button>
            </section>

            <!-- WIN SCREEN -->
            <section id="win-screen" class="screen hidden space-y-4 sm:space-y-6">
                <div class="text-7xl sm:text-9xl">üèÜ</div>
                <h2 class="text-4xl sm:text-6xl font-black text-red-500">Awesome!</h2>
                <p class="text-lg sm:text-2xl text-gray-600 font-bold text-center">You are the Ordinal Champion!</p>
                <div id="final-score" class="text-2xl sm:text-4xl font-black text-orange-500 bg-orange-50 px-8 py-3 sm:px-12 sm:py-5 rounded-[20px] sm:rounded-[30px] border-4 sm:border-8 border-orange-200 shadow-lg">Score: 0</div>
                <button onclick="resetGame()" class="bg-blue-500 text-white py-4 px-10 sm:py-5 sm:px-14 rounded-full text-2xl sm:text-3xl font-bold shadow-xl btn-bounce">Play Again ‚Ü∫</button>
            </section>

        </main>

        <!-- Confetti Overlay -->
        <canvas id="confetti-canvas" class="absolute inset-0 pointer-events-none z-50"></canvas>
    </div>

    <script>
        // Data Level 1
        const level1Data = [
            { word: "First", number: "1st", wrongNums: ["3rd", "5th", "10th"] },
            { word: "Second", number: "2nd", wrongNums: ["1st", "4th", "6th"] },
            { word: "Third", number: "3rd", wrongNums: ["2nd", "7th", "9th"] },
            { word: "Fourth", number: "4th", wrongNums: ["5th", "1st", "8th"] },
            { word: "Fifth", number: "5th", wrongNums: ["4th", "6th", "2nd"] },
            { word: "Sixth", number: "6th", wrongNums: ["9th", "3rd", "5th"] },
            { word: "Seventh", number: "7th", wrongNums: ["10th", "8th", "1st"] },
            { word: "Eighth", number: "8th", wrongNums: ["6th", "7th", "2nd"] },
            { word: "Ninth", number: "9th", wrongNums: ["6th", "8th", "4th"] },
            { word: "Tenth", number: "10th", wrongNums: ["1st", "5th", "9th"] }
        ];

        const level2Data = [
            { word: "First", num: "1st" }, { word: "Second", num: "2nd" },
            { word: "Third", num: "3rd" }, { word: "Fourth", num: "4th" },
            { word: "Fifth", num: "5th" }, { word: "Sixth", num: "6th" },
            { word: "Seventh", num: "7th" }, { word: "Eighth", num: "8th" },
            { word: "Ninth", num: "9th" }, { word: "Tenth", num: "10th" }
        ];

        const level3Data = {
            characters: ["ü¶Ñ", "ü¶Å", "ü¶ñ", "ü§ñ", "üêº", "üê∏", "üëΩ", "üê∞", "ü¶ä", "üêØ"],
            questions: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
        };

        const rewards = ["üç≠", "üç¶", "üèéÔ∏è", "üöÄ", "üß∏", "üéà", "üåü", "üç©"];

        // Game State
        let currentLevel = 0;
        let score = 0;
        let currentQuestionIndex = 0;
        let pendingNextLevel = 0;
        let l2Selected = null;
        let l2MatchesFound = 0;
        let audioCtx;

        function playSound(type) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!audioCtx) audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(80, now + 0.2);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'pop') {
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(900, now + 0.05);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                osc.start(now); osc.stop(now + 0.05);
            }
        }

        function speakText(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 1.0;
            utterance.pitch = 1.2;
            window.speechSynthesis.speak(utterance);
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function updateHeader() {
            document.getElementById('level-indicator').textContent = currentLevel > 0 && currentLevel < 4 ? `Level: ${currentLevel}` : "";
            document.getElementById('score-board').textContent = `Score: ${score}`;
        }

        function resetGame() {
            score = 0;
            currentLevel = 0;
            showScreen('start-screen');
            updateHeader();
        }

        function startLevel(level) {
            currentLevel = level;
            currentQuestionIndex = 0;
            updateHeader();
            if (level === 1) initLevel1();
            else if (level === 2) initLevel2();
            else if (level === 3) initLevel3();
            else showWinScreen();
        }

        // --- LEVEL 1 ---
        let l1Questions = [];
        function initLevel1() {
            showScreen('level-1');
            l1Questions = [...level1Data].sort(() => Math.random() - 0.5);
            loadL1Question();
        }

        function loadL1Question() {
            if (currentQuestionIndex >= l1Questions.length) {
                setTimeout(() => startBonusRound(2), 800);
                return;
            }
            const q = l1Questions[currentQuestionIndex];
            document.getElementById('l1-prompt').textContent = `${q.word}`;
            document.getElementById('l1-audio-btn').onclick = () => speakText(q.word);

            const grid = document.getElementById('l1-grid');
            grid.innerHTML = '';
            const options = [q.number, ...q.wrongNums].sort(() => Math.random() - 0.5);
            
            // M√†u h·ªìng ph·∫•n m·∫∑c ƒë·ªãnh
            const initialColor = '#FFB6C1'; 

            options.forEach((opt, idx) => {
                const b = document.createElement('button');
                // T√πy ch·ªânh k√≠ch th∆∞·ªõc cho mobile
                b.className = `balloon h-28 sm:h-36 flex items-center justify-center text-white font-extrabold rounded-[45%] shadow-xl text-2xl sm:text-3xl btn-bounce transition-colors duration-300`;
                b.style.backgroundColor = initialColor;
                b.style.color = initialColor; 
                b.innerHTML = `<span class="text-white">${opt}</span>`;
                
                b.onclick = () => {
                    if (b.disabled) return;
                    if (opt === q.number) {
                        playSound('correct');
                        b.classList.add('animate-pop');
                        b.style.backgroundColor = '#2ED573';
                        b.style.color = '#2ED573';
                        b.innerHTML = `<span class="text-white flex flex-col items-center"><span>${opt}</span><span class="text-[10px] sm:text-sm font-bold mt-1 uppercase">Correct</span></span>`;
                        score++;
                        currentQuestionIndex++;
                        updateHeader();
                        document.querySelectorAll('#l1-grid button').forEach(btn => btn.disabled = true);
                        setTimeout(loadL1Question, 1200);
                    } else {
                        playSound('wrong');
                        b.classList.add('animate-shake');
                        const originalHtml = b.innerHTML;
                        b.style.backgroundColor = '#FF4757';
                        b.style.color = '#FF4757';
                        b.innerHTML = `<span class="text-white flex flex-col items-center"><span>${opt}</span><span class="text-[10px] sm:text-sm font-bold mt-1 uppercase text-center">Try<br>again</span></span>`;
                        setTimeout(() => {
                            b.classList.remove('animate-shake');
                            b.style.backgroundColor = initialColor;
                            b.style.color = initialColor;
                            b.innerHTML = originalHtml;
                        }, 1000);
                    }
                };
                grid.appendChild(b);
            });
        }

        // --- LEVEL 2 ---
        function initLevel2() {
            showScreen('level-2');
            l2MatchesFound = 0;
            l2Selected = null;
            const wCol = document.getElementById('l2-words');
            const nCol = document.getElementById('l2-nums');
            wCol.innerHTML = ''; nCol.innerHTML = '';
            const words = [...level2Data].sort(() => Math.random() - 0.5);
            const nums = [...level2Data].sort(() => Math.random() - 0.5);
            words.forEach(p => wCol.appendChild(createMatchBtn(p.word, 'word', p.num)));
            nums.forEach(p => nCol.appendChild(createMatchBtn(p.num, 'num', p.num)));
        }

        function createMatchBtn(text, type, matchVal) {
            const b = document.createElement('button');
            b.className = "p-3 sm:p-5 bg-white border-2 sm:border-4 border-gray-100 rounded-xl sm:rounded-2xl font-bold text-gray-600 shadow-sm transition-all btn-bounce active:border-blue-400 text-sm sm:text-lg";
            b.textContent = text;
            b.onclick = () => {
                if (b.classList.contains('matched')) return;
                playSound('pop');
                speakText(text === "1st" ? "First" : text === "2nd" ? "Second" : text === "3rd" ? "Third" : text);
                if (l2Selected) {
                    if (l2Selected === b) {
                        b.classList.remove('border-blue-400', 'bg-blue-50');
                        l2Selected = null; return;
                    }
                    if (l2Selected.dataset.type !== type && l2Selected.dataset.match === matchVal) {
                        playSound('correct');
                        b.classList.add('matched', 'bg-green-100', 'border-green-400', 'text-green-700');
                        l2Selected.classList.add('matched', 'bg-green-100', 'border-green-400', 'text-green-700');
                        b.innerHTML += ' ‚úì';
                        l2Selected.innerHTML += ' ‚úì';
                        l2MatchesFound++; score++; updateHeader();
                        l2Selected = null;
                        if (l2MatchesFound === level2Data.length) setTimeout(() => startBonusRound(3), 800);
                    } else {
                        playSound('wrong');
                        b.classList.add('animate-shake');
                        l2Selected.classList.add('animate-shake');
                        setTimeout(() => {
                            b.classList.remove('animate-shake', 'border-blue-400', 'bg-blue-50');
                            l2Selected.classList.remove('animate-shake', 'border-blue-400', 'bg-blue-50');
                            l2Selected = null;
                        }, 400);
                    }
                } else {
                    l2Selected = b;
                    b.classList.add('border-blue-400', 'bg-blue-50');
                    b.dataset.type = type;
                    b.dataset.match = matchVal;
                }
            };
            return b;
        }

        // --- LEVEL 3 ---
        let l3Questions = [];
        let l3TargetIdx = -1;

        function initLevel3() {
            showScreen('level-3');
            renderLevel3Line();
            l3Questions = [...level3Data.questions].sort(() => Math.random() - 0.5);
            askL3Question();
        }

        function renderLevel3Line() {
            const line = document.getElementById('l3-line');
            line.innerHTML = '<div class="bg-gray-800 text-white p-1 rounded font-bold text-[8px] uppercase [writing-mode:vertical-lr] rotate-180">START</div>';
            level3Data.characters.forEach((char, idx) => {
                const d = document.createElement('div');
                d.id = `l3-char-${idx}`;
                d.className = "bg-white p-1 rounded-lg border border-gray-100 shadow-sm flex flex-col items-center gap-0.5 flex-1 max-w-[38px] transition-all";
                d.innerHTML = `<div class="text-xl sm:text-3xl">${char}</div><div class="num-indicator text-gray-500 font-bold text-[8px] sm:text-[12px]">${getOrdinal(idx + 1)}</div>`;
                line.appendChild(d);
            });
        }

        function getOrdinal(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return n + (s[(v - 20) % 10] || s[v] || s[0]);
        }

        function askL3Question() {
            if (currentQuestionIndex >= l3Questions.length) {
                setTimeout(() => startLevel(4), 800);
                return;
            }
            const targetPos = l3Questions[currentQuestionIndex];
            l3TargetIdx = targetPos - 1;
            const ord = getOrdinal(targetPos);
            document.getElementById('l3-question').innerHTML = `Who is in the <span class="text-2xl sm:text-4xl text-red-500 font-black">${ord}</span> place?`;
            document.getElementById('l3-audio-btn').onclick = () => speakText(`${ord} place`);
            renderLevel3Options();
        }

        function renderLevel3Options() {
            const optionsContainer = document.getElementById('l3-options');
            optionsContainer.innerHTML = '';
            
            const correctEmoji = level3Data.characters[l3TargetIdx];
            const otherEmojis = level3Data.characters.filter(e => e !== correctEmoji);
            const shuffledOthers = otherEmojis.sort(() => Math.random() - 0.5);
            const choices = [correctEmoji, ...shuffledOthers.slice(0, 3)].sort(() => Math.random() - 0.5);

            choices.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = "bg-white border-2 sm:border-4 border-gray-100 p-3 sm:p-4 rounded-2xl sm:rounded-3xl text-3xl sm:text-5xl shadow-sm btn-bounce hover:border-blue-300 transition-colors flex items-center justify-center aspect-square sm:aspect-auto";
                btn.textContent = emoji;
                btn.onclick = () => {
                    if (emoji === correctEmoji) {
                        playSound('correct');
                        btn.classList.add('bg-green-100', 'border-green-400', 'animate-pop');
                        const charEl = document.getElementById(`l3-char-${l3TargetIdx}`);
                        charEl.classList.add('bg-green-50', 'border-green-400');
                        charEl.querySelector('.num-indicator').className = "num-indicator text-green-600 font-bold text-[8px] sm:text-[12px]";
                        score++;
                        currentQuestionIndex++;
                        updateHeader();
                        document.querySelectorAll('#l3-options button').forEach(b => b.disabled = true);
                        setTimeout(askL3Question, 1200);
                    } else {
                        playSound('wrong');
                        btn.classList.add('animate-shake', 'border-red-300');
                        setTimeout(() => btn.classList.remove('animate-shake'), 300);
                    }
                };
                optionsContainer.appendChild(btn);
            });
        }

        // --- BONUS ---
        function startBonusRound(next) {
            pendingNextLevel = next;
            showScreen('bonus-screen');
            const container = document.getElementById('gift-container');
            container.innerHTML = '';
            document.getElementById('bonus-next-btn').classList.add('hidden');
            document.getElementById('bonus-reward-display').innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const b = document.createElement('button');
                b.className = "text-6xl sm:text-8xl animate-bounce hover:scale-110 transition-transform";
                b.textContent = 'üéÅ';
                b.onclick = () => {
                    document.querySelectorAll('#gift-container button').forEach(btn => btn.disabled = true);
                    b.textContent = rewards[Math.floor(Math.random() * rewards.length)];
                    b.classList.remove('animate-bounce'); b.classList.add('animate-pop');
                    document.getElementById('bonus-reward-display').innerHTML = `<span class="text-xl sm:text-3xl font-bold text-orange-500 text-center">Wow! You found a prize!</span>`;
                    document.getElementById('bonus-next-btn').classList.remove('hidden');
                    startConfetti(); playSound('correct');
                };
                container.appendChild(b);
            }
        }

        function nextLevelFromBonus() { startLevel(pendingNextLevel); }

        function showWinScreen() {
            showScreen('win-screen');
            document.getElementById('final-score').textContent = `Total Score: ${score}`;
            startConfetti();
        }

        function startConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            let particles = Array.from({ length: 120 }, () => ({
                x: Math.random() * canvas.width,
                y: -20 - (Math.random() * 100),
                r: Math.random() * 8 + 4,
                d: Math.random() * 100,
                color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                tilt: Math.random() * 10 - 10,
                speedY: Math.random() * 3 + 3,
                speedX: Math.random() * 2 - 1
            }));
            let active = true;
            setTimeout(() => { active = false; }, 4000);
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let onScreen = 0;
                particles.forEach((p) => {
                    if (p.y < canvas.height + 20) {
                        onScreen++;
                        ctx.beginPath();
                        ctx.lineWidth = p.r;
                        ctx.strokeStyle = p.color;
                        ctx.moveTo(p.x + p.tilt + p.r / 2, p.y);
                        ctx.lineTo(p.x + p.tilt, p.y + p.tilt + p.r / 2);
                        ctx.stroke();
                        p.y += p.speedY; p.x += p.speedX; p.tilt = Math.sin(p.d) * 15; p.d += 0.05;
                    }
                });
                if (active || onScreen > 0) requestAnimationFrame(draw);
                else ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            draw();
        }
    </script>
</body>
</html>

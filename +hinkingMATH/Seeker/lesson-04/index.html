<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../assets/brand.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magical Shape Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #ec4899;
            --accent: #f59e0b;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(180deg, #87ceeb 0%, #e0f2fe 100%);
            overflow: hidden;
            touch-action: manipulation;
        }

        /* Hi·ªáu ·ª©ng m√¢y bay n·ªÅn */
        .cloud {
            position: absolute;
            background: white;
            border-radius: 50px;
            opacity: 0.8;
            z-index: -1;
            animation: move-clouds 30s linear infinite;
        }
        .cloud::before, .cloud::after {
            content: '';
            position: absolute;
            background: white;
            border-radius: 50%;
        }
        .cloud:nth-child(1) { width: 100px; height: 40px; top: 10%; left: -150px; animation-duration: 40s; }
        .cloud:nth-child(2) { width: 150px; height: 60px; top: 25%; left: -200px; animation-duration: 55s; animation-delay: 5s; }
        .cloud:nth-child(3) { width: 120px; height: 50px; top: 60%; left: -180px; animation-duration: 45s; animation-delay: 15s; }

        @keyframes move-clouds {
            from { transform: translateX(0); }
            to { transform: translateX(calc(100vw + 300px)); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        .shake { animation: shake 0.5s ease-in-out; }

        @keyframes bounce-pop {
            0% { transform: scale(0.8); opacity: 0; }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        .bounce-pop { animation: bounce-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* C√°c kh·ªëi h√¨nh c√≥ chi·ªÅu s√¢u */
        .shape-glossy {
            position: relative;
            overflow: hidden;
        }
        .shape-glossy::after {
            content: '';
            position: absolute;
            top: 10%;
            left: 10%;
            width: 30%;
            height: 30%;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
        }

        /* N√∫t b·∫•m ki·ªÉu k·∫πo ng·ªçt (3D) */
        .btn-candy {
            position: relative;
            transition: all 0.2s;
            border-bottom: 6px solid rgba(0,0,0,0.15);
        }
        .btn-candy:hover { transform: translateY(-2px); border-bottom-width: 8px; }
        .btn-candy:active { transform: translateY(4px); border-bottom-width: 2px; }

        .pedestal {
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
        }

        .treasure-item {
            font-size: 4rem;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1));
            animation: treasure-float 3s ease-in-out infinite;
        }
        @keyframes treasure-float {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-15px) scale(1.1); }
        }

        .particle {
            position: absolute;
            width: 12px;
            height: 12px;
            pointer-events: none;
            opacity: 0;
            z-index: 100;
        }

        @keyframes firework-burst {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tw-x), var(--tw-y)) scale(0); opacity: 0; }
        }

        @keyframes fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <!-- Hi·ªáu ·ª©ng m√¢y n·ªÅn -->
    <img src="../assets/logo-oodles-math.png" class="oodles-logo">
    <div class="cloud"></div>
    <div class="cloud"></div>
    <div class="cloud"></div>

    <div id="game-container" class="w-full max-w-4xl bg-white/90 backdrop-blur-md rounded-[3rem] shadow-[0_25px_50px_-12px_rgba(0,0,0,0.25)] p-6 md:p-10 text-center relative overflow-hidden border-8 border-white">
        
        <!-- M√†n h√¨nh b·∫Øt ƒë·∫ßu -->
        <div id="start-screen" class="absolute inset-0 bg-white z-50 flex flex-col items-center justify-center p-6 text-center">
            <div class="treasure-item mb-4">üåà</div>
            <h1 class="text-6xl md:text-7xl font-black text-indigo-600 mb-2 drop-shadow-sm">Shape Fun!</h1>
            <p class="text-2xl text-pink-400 mb-10 font-bold uppercase tracking-widest">A Magic Adventure</p>
            <button id="start-button" class="btn-candy bg-indigo-500 text-white text-3xl font-black py-5 px-16 rounded-3xl shadow-lg hover:bg-indigo-600">
                PLAY NOW!
            </button>
        </div>

        <!-- Thanh th√¥ng tin -->
        <div class="flex justify-between items-center mb-6">
            <div id="progress-text" class="bg-indigo-100 text-indigo-600 px-6 py-2 rounded-2xl font-black text-lg">LEVEL 1 / 15</div>
            <div id="score" class="bg-pink-100 text-pink-500 px-6 py-2 rounded-2xl font-black text-lg">‚ú® TREASURES: 0</div>
        </div>
        
        <!-- Thanh ti·∫øn tr√¨nh v·ªõi t√™n l·ª≠a -->
        <div class="relative w-full h-8 mb-10 bg-slate-100 rounded-full p-1 shadow-inner">
            <div id="progress-bar" class="h-full bg-gradient-to-r from-indigo-400 to-pink-400 rounded-full transition-all duration-700 flex justify-end items-center px-1" style="width: 0%;">
                <div class="w-6 h-6 bg-white rounded-full shadow-md flex items-center justify-center text-xs">üöÄ</div>
            </div>
        </div>

        <!-- Khu v·ª±c c√¢u h·ªèi -->
        <div id="question-area">
            <div class="flex justify-center items-center gap-4 mb-8"> 
                <h2 id="question-text" class="text-4xl md:text-5xl font-black text-slate-800">What's next?</h2>
                <button id="replay-speech-button" class="btn-candy bg-yellow-400 text-yellow-900 p-4 rounded-3xl shadow-md hover:scale-110 active:scale-95 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                    </svg>
                </button>
            </div>
            
            <div id="pattern-display" class="flex flex-wrap justify-center items-center gap-4 min-h-[160px] bg-indigo-50/50 rounded-[3rem] p-10 mb-12 border-4 border-dashed border-indigo-200">
                <!-- N·ªôi dung ƒë∆∞·ª£c JS t·∫°o -->
            </div>
        </div>

        <!-- Khu v·ª±c l·ª±a ch·ªçn -->
        <div id="options-display" class="flex flex-wrap justify-center gap-8">
            <!-- N·ªôi dung ƒë∆∞·ª£c JS t·∫°o -->
        </div>

        <!-- L·ªõp ph·ªß ph·∫£n h·ªìi -->
        <div id="feedback-modal" class="absolute inset-0 bg-white/95 flex items-center justify-center z-20 hidden">
            <div id="feedback-content" class="text-7xl md:text-9xl font-black drop-shadow-lg scale-0 transition-transform duration-500">
                GREAT!
            </div>
        </div>

        <!-- V√≤ng th∆∞·ªüng (Kho b√°u) -->
        <div id="bonus-modal" class="absolute inset-0 bg-gradient-to-br from-indigo-500/95 to-purple-600/95 flex flex-col items-center justify-center z-30 hidden p-6">
            <h2 class="text-5xl md:text-7xl font-black text-white mb-4 animate-bounce drop-shadow-md">MAGIC CHEST!</h2>
            <p class="text-2xl text-white/90 font-bold mb-12">Pick a box to find a surprise!</p>
            <div id="door-container" class="flex flex-wrap justify-center gap-8 md:gap-16">
                <!-- C√°c r∆∞∆°ng b√°u -->
            </div>
            <p id="bonus-result" class="text-4xl text-yellow-300 font-black mt-12 hidden"></p>
        </div>

        <!-- M√†n h√¨nh k·∫øt th√∫c game -->
        <div id="game-over-modal" class="absolute inset-0 bg-indigo-600 flex flex-col items-center justify-center z-40 hidden p-6 text-white">
            <div class="treasure-item mb-8">üèÜ</div>
            <h2 class="text-6xl md:text-9xl font-black mb-4 drop-shadow-lg">SUPER STAR!</h2>
            <p class="text-3xl font-bold mb-4">All patterns are solved!</p>
            <p id="final-score" class="text-5xl text-yellow-300 font-black mb-14">Treasures: 0</p>
            <button id="play-again-button" class="btn-candy bg-white text-indigo-600 text-3xl font-black py-6 px-16 rounded-full shadow-2xl hover:scale-105 active:scale-95">
                PLAY AGAIN!
            </button>
        </div>

        <div id="fx-container" class="absolute inset-0 pointer-events-none z-50"></div>
    </div>

    <script>
        // --- C·∫•u h√¨nh & D·ªØ li·ªáu ---
        const shapes = {
            RED_CIRCLE: { shape: 'circle', color: 'bg-red-500', value: 'Red Circle' },
            BLUE_SQUARE: { shape: 'square', color: 'bg-blue-500', value: 'Blue Square' },
            GREEN_TRIANGLE: { shape: 'triangle', color: 'border-b-green-500', value: 'Green Triangle' },
            YELLOW_STAR: { shape: 'star', color: 'text-yellow-400', value: 'Yellow Star' },
            PURPLE_CIRCLE: { shape: 'circle', color: 'bg-purple-500', value: 'Purple Circle' },
            ORANGE_SQUARE: { shape: 'square', color: 'bg-orange-500', value: 'Orange Square' },
            PINK_TRIANGLE: { shape: 'triangle', color: 'border-b-pink-500', value: 'Pink Triangle' },
            TEAL_STAR: { shape: 'star', color: 'text-teal-400', value: 'Teal Star' }
        };

        const treasures = [
            { icon: "üß∏", name: "Teddy" },
            { icon: "üåà", name: "Rainbow" },
            { icon: "ü¶Ñ", name: "Unicorn" },
            { icon: "üç≠", name: "Candy" },
            { icon: "üöÄ", name: "Rocket" },
            { icon: "üç¶", name: "Ice Cream" },
            { icon: "üíé", name: "Diamond" },
            { icon: "üê±", name: "Kitty" },
            { icon: "üé®", name: "Art" },
            { icon: "üîî", name: "Magic Bell" }
        ];

        const questions = [
            { pattern: [shapes.RED_CIRCLE, shapes.BLUE_SQUARE, shapes.RED_CIRCLE, shapes.BLUE_SQUARE], options: [shapes.RED_CIRCLE, shapes.GREEN_TRIANGLE, shapes.BLUE_SQUARE], correct: shapes.RED_CIRCLE },
            { pattern: [shapes.GREEN_TRIANGLE, shapes.GREEN_TRIANGLE, shapes.YELLOW_STAR, shapes.YELLOW_STAR], options: [shapes.YELLOW_STAR, shapes.GREEN_TRIANGLE, shapes.RED_CIRCLE], correct: shapes.GREEN_TRIANGLE },
            { pattern: [shapes.RED_CIRCLE, shapes.BLUE_SQUARE, shapes.GREEN_TRIANGLE, shapes.RED_CIRCLE, shapes.BLUE_SQUARE], options: [shapes.RED_CIRCLE, shapes.BLUE_SQUARE, shapes.GREEN_TRIANGLE], correct: shapes.GREEN_TRIANGLE },
            { pattern: [shapes.PURPLE_CIRCLE, shapes.PURPLE_CIRCLE, shapes.ORANGE_SQUARE, shapes.PURPLE_CIRCLE, shapes.PURPLE_CIRCLE], options: [shapes.PURPLE_CIRCLE, shapes.TEAL_STAR, shapes.ORANGE_SQUARE], correct: shapes.ORANGE_SQUARE },
            { pattern: [shapes.YELLOW_STAR, shapes.PINK_TRIANGLE, shapes.PINK_TRIANGLE, shapes.YELLOW_STAR, shapes.PINK_TRIANGLE], options: [shapes.YELLOW_STAR, shapes.PINK_TRIANGLE, shapes.PURPLE_CIRCLE], correct: shapes.PINK_TRIANGLE },
            { pattern: [shapes.BLUE_SQUARE, shapes.BLUE_SQUARE, shapes.RED_CIRCLE, shapes.RED_CIRCLE], options: [shapes.BLUE_SQUARE, shapes.RED_CIRCLE, shapes.GREEN_TRIANGLE], correct: shapes.BLUE_SQUARE },
            { pattern: [shapes.TEAL_STAR, shapes.ORANGE_SQUARE, shapes.PINK_TRIANGLE, shapes.TEAL_STAR, shapes.ORANGE_SQUARE], options: [shapes.PINK_TRIANGLE, shapes.TEAL_STAR, shapes.ORANGE_SQUARE], correct: shapes.PINK_TRIANGLE },
            { pattern: [shapes.RED_CIRCLE, shapes.RED_CIRCLE, shapes.BLUE_SQUARE, shapes.RED_CIRCLE, shapes.RED_CIRCLE], options: [shapes.RED_CIRCLE, shapes.BLUE_SQUARE, shapes.YELLOW_STAR], correct: shapes.BLUE_SQUARE },
            { pattern: [shapes.GREEN_TRIANGLE, shapes.PURPLE_CIRCLE, shapes.PURPLE_CIRCLE, shapes.GREEN_TRIANGLE, shapes.PURPLE_CIRCLE], options: [shapes.PURPLE_CIRCLE, shapes.GREEN_TRIANGLE, shapes.RED_CIRCLE], correct: shapes.PURPLE_CIRCLE },
            { pattern: [shapes.YELLOW_STAR, shapes.PURPLE_CIRCLE, shapes.YELLOW_STAR, shapes.PURPLE_CIRCLE], options: [shapes.PURPLE_CIRCLE, shapes.YELLOW_STAR, shapes.BLUE_SQUARE], correct: shapes.YELLOW_STAR },
            { pattern: [shapes.TEAL_STAR, shapes.TEAL_STAR, shapes.RED_CIRCLE, shapes.TEAL_STAR, shapes.TEAL_STAR], options: [shapes.TEAL_STAR, shapes.RED_CIRCLE, shapes.ORANGE_SQUARE], correct: shapes.RED_CIRCLE },
            { pattern: [shapes.RED_CIRCLE, shapes.BLUE_SQUARE, shapes.RED_CIRCLE, shapes.BLUE_SQUARE], options: [shapes.RED_CIRCLE, shapes.BLUE_SQUARE, shapes.GREEN_TRIANGLE], correct: shapes.RED_CIRCLE },
            { pattern: [shapes.PINK_TRIANGLE, shapes.PINK_TRIANGLE, shapes.TEAL_STAR, shapes.PINK_TRIANGLE, shapes.PINK_TRIANGLE], options: [shapes.TEAL_STAR, shapes.PINK_TRIANGLE, shapes.RED_CIRCLE], correct: shapes.TEAL_STAR },
            { pattern: [shapes.PURPLE_CIRCLE, shapes.GREEN_TRIANGLE, shapes.PURPLE_CIRCLE, shapes.GREEN_TRIANGLE], options: [shapes.PURPLE_CIRCLE, shapes.GREEN_TRIANGLE, shapes.YELLOW_STAR], correct: shapes.PURPLE_CIRCLE },
            { pattern: [shapes.ORANGE_SQUARE, shapes.ORANGE_SQUARE, shapes.RED_CIRCLE, shapes.ORANGE_SQUARE], options: [shapes.ORANGE_SQUARE, shapes.RED_CIRCLE, shapes.BLUE_SQUARE], correct: shapes.ORANGE_SQUARE }
        ];

        let score = 0;
        let currentQuestionIndex = 0;
        let isChecking = false;
        let gameOverLoop = null;
        const totalQuestions = questions.length;

        // √Çm thanh
        let correctSynth, incorrectSynth, bonusSynth, clickSynth;
        function initAudio() {
            if (correctSynth) return;
            correctSynth = new Tone.PolySynth(Tone.Synth).toDestination();
            incorrectSynth = new Tone.PolySynth(Tone.Synth).toDestination();
            bonusSynth = new Tone.PolySynth(Tone.Synth).toDestination();
            clickSynth = new Tone.MembraneSynth().toDestination();
            Tone.start();
        }

        const speechSynth = window.speechSynthesis;
        function speak(text) {
            speechSynth.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US';
            u.rate = 1.0;
            u.pitch = 1.3;
            speechSynth.speak(u);
        }

        // --- DOM Elements ---
        const startScreen = document.getElementById('start-screen');
        const startBtn = document.getElementById('start-button');
        const patternDisplay = document.getElementById('pattern-display');
        const optionsDisplay = document.getElementById('options-display');
        const feedbackModal = document.getElementById('feedback-modal');
        const feedbackContent = document.getElementById('feedback-content');
        const bonusModal = document.getElementById('bonus-modal');
        const gameOverModal = document.getElementById('game-over-modal');
        const scoreEl = document.getElementById('score');
        const progressTextEl = document.getElementById('progress-text');
        const progressBarEl = document.getElementById('progress-bar');
        const doorContainer = document.getElementById('door-container');
        const fxContainer = document.getElementById('fx-container');

        // --- Hi·ªáu ·ª©ng h√¨nh ·∫£nh ---
        function createConfetti() {
            const colors = ['#818cf8', '#f472b6', '#34d399', '#fbbf24', '#a78bfa'];
            for (let i = 0; i < 60; i++) {
                const c = document.createElement('div');
                c.className = 'particle';
                c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                c.style.left = `${Math.random() * 100}%`;
                c.style.top = `-20px`;
                c.style.animation = `fall ${2 + Math.random() * 2}s ease-out forwards`;
                c.style.opacity = '1';
                fxContainer.appendChild(c);
                setTimeout(() => c.remove(), 4000);
            }
        }

        function launchFirework() {
            const colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFA500'];
            const x = 10 + Math.random() * 80;
            const y = 20 + Math.random() * 60;
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            for (let i = 0; i < 40; i++) {
                const p = document.createElement('div');
                const angle = (Math.PI * 2 * i) / 40;
                const distance = 80 + Math.random() * 200;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;

                p.className = 'particle';
                p.style.backgroundColor = color;
                p.style.left = `${x}%`;
                p.style.top = `${y}%`;
                p.style.setProperty('--tw-x', `${tx}px`);
                p.style.setProperty('--tw-y', `${ty}px`);
                p.style.animation = `firework-burst 1.2s cubic-bezier(0.1, 0.5, 0.5, 1) forwards`;
                fxContainer.appendChild(p);
                setTimeout(() => p.remove(), 1200);
            }
        }

        // --- H√†m h·ªó tr·ª£ v·∫Ω h√¨nh ---
        function getShapeHtml(item, isLarge = true) {
            const size = isLarge ? "w-20 h-20" : "w-16 h-16";
            const triSize = isLarge ? "border-l-[40px] border-r-[40px] border-b-[70px]" : "border-l-[32px] border-r-[32px] border-b-[56px]";
            
            let shapeInner = '';
            if (item.shape === 'circle') shapeInner = `<div class="${size} ${item.color} rounded-full shadow-[inset_-4px_-4px_8px_rgba(0,0,0,0.2)] shape-glossy"></div>`;
            if (item.shape === 'square') shapeInner = `<div class="${size} ${item.color} rounded-3xl shadow-[inset_-4px_-4px_8px_rgba(0,0,0,0.2)] shape-glossy"></div>`;
            if (item.shape === 'triangle') shapeInner = `<div class="w-0 h-0 ${triSize} ${item.color} drop-shadow-lg filter brightness-110"></div>`;
            if (item.shape === 'star') shapeInner = `<svg class="w-24 h-24 ${item.color} fill-current drop-shadow-lg" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`;
            
            return `<div class="shape-container p-2 pedestal flex items-center justify-center">${shapeInner}</div>`;
        }

        // --- Logic ch√≠nh ---
        function loadQuestion() {
            if (currentQuestionIndex >= totalQuestions) {
                showGameOver();
                return;
            }
            isChecking = false;
            const q = questions[currentQuestionIndex];
            
            patternDisplay.innerHTML = '';
            q.pattern.forEach((item, idx) => {
                const el = document.createElement('div');
                el.className = 'bounce-pop';
                el.style.animationDelay = `${idx * 0.1}s`;
                el.innerHTML = getShapeHtml(item);
                patternDisplay.appendChild(el);
            });
            
            const questionMark = document.createElement('div');
            questionMark.className = 'bounce-pop';
            questionMark.style.animationDelay = `${q.pattern.length * 0.1}s`;
            questionMark.innerHTML = `
                <div class="shape-container pedestal">
                    <div class="w-20 h-20 bg-white border-4 border-dashed border-indigo-200 rounded-[2rem] flex items-center justify-center text-5xl font-black text-indigo-100">?</div>
                </div>
            `;
            patternDisplay.appendChild(questionMark);

            optionsDisplay.innerHTML = '';
            [...q.options].sort(() => Math.random() - 0.5).forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'btn-candy bg-white rounded-[2.5rem] p-8 shadow-xl border-4 border-slate-50 hover:bg-slate-50 active:bg-indigo-50 transition-colors';
                btn.innerHTML = getShapeHtml(opt, false);
                btn.onclick = () => handleChoice(opt, btn);
                optionsDisplay.appendChild(btn);
            });

            updateUI();
            // ƒê√É X√ìA T·ª∞ ƒê·ªòNG speak()
        }

        function handleChoice(selected, btn) {
            if (isChecking) return;
            isChecking = true;
            initAudio();
            clickSynth.triggerAttackRelease('C4', '8n');

            const correct = questions[currentQuestionIndex].correct;
            const isMatch = JSON.stringify(selected) === JSON.stringify(correct);

            if (isMatch) {
                correctSynth.triggerAttackRelease(["C5", "E5", "G5"], "0.3");
                createConfetti();
                feedbackContent.textContent = "GREAT!";
                feedbackContent.className = "text-8xl md:text-9xl font-black text-green-500 drop-shadow-lg transform scale-100 transition-transform duration-500";
                feedbackModal.classList.remove('hidden');
                setTimeout(() => {
                    feedbackModal.classList.add('hidden');
                    feedbackContent.classList.add('scale-0');
                    showBonus();
                }, 1200);
            } else {
                incorrectSynth.triggerAttackRelease(["C4", "B3"], "0.3");
                document.getElementById('game-container').classList.add('shake');
                btn.classList.add('bg-red-50', 'border-red-100');
                
                feedbackContent.textContent = "TRY AGAIN!";
                feedbackContent.className = "text-8xl md:text-9xl font-black text-red-500 drop-shadow-lg transform scale-100 transition-transform duration-500";
                feedbackModal.classList.remove('hidden');
                // ƒê√É X√ìA T·ª∞ ƒê·ªòNG speak()

                setTimeout(() => {
                    document.getElementById('game-container').classList.remove('shake');
                    btn.classList.remove('bg-red-50', 'border-red-100');
                    feedbackModal.classList.add('hidden');
                    feedbackContent.classList.add('scale-0');
                    isChecking = false;
                }, 1000);
            }
        }

        function showBonus() {
            bonusModal.classList.remove('hidden');
            document.getElementById('bonus-result').classList.add('hidden');
            
            const pool = [...treasures].sort(() => Math.random() - 0.5).slice(0, 3);
            doorContainer.innerHTML = '';
            
            pool.forEach((treasure, idx) => {
                const chest = document.createElement('button');
                chest.className = 'btn-candy w-40 h-40 bg-white/20 backdrop-blur-md rounded-[2.5rem] border-4 border-white shadow-2xl flex items-center justify-center text-7xl hover:bg-white/40 active:scale-110 transition-all';
                chest.innerHTML = `üéÅ`;
                chest.onclick = () => {
                    if (chest.disabled) return;
                    bonusSynth.triggerAttackRelease("G4", "0.2");
                    
                    const allChests = doorContainer.querySelectorAll('button');
                    allChests.forEach((c, i) => {
                        c.disabled = true;
                        const item = pool[i];
                        c.innerHTML = item.icon;
                        if (item === treasure) {
                            c.classList.add('scale-125', 'bg-white', 'rotate-6');
                        } else {
                            c.classList.add('opacity-40', 'scale-90');
                        }
                    });

                    score++;
                    updateUI();
                    document.getElementById('bonus-result').textContent = `You found a ${treasure.name}!`;
                    document.getElementById('bonus-result').classList.remove('hidden');
                    // ƒê√É X√ìA T·ª∞ ƒê·ªòNG speak()

                    setTimeout(() => {
                        bonusModal.classList.add('hidden');
                        currentQuestionIndex++;
                        loadQuestion();
                    }, 2500);
                };
                doorContainer.appendChild(chest);
            });
            // ƒê√É X√ìA T·ª∞ ƒê·ªòNG speak()
        }

        function updateUI() {
            scoreEl.textContent = `‚ú® TREASURES: ${score}`;
            progressTextEl.textContent = `LEVEL ${Math.min(currentQuestionIndex + 1, totalQuestions)} / ${totalQuestions}`;
            progressBarEl.style.width = `${(currentQuestionIndex / totalQuestions) * 100}%`;
        }

        function showGameOver() {
            document.getElementById('final-score').textContent = `Treasures Found: ${score}`;
            gameOverModal.classList.remove('hidden');
            // ƒê√É X√ìA T·ª∞ ƒê·ªòNG speak()
            
            if (gameOverLoop) clearInterval(gameOverLoop);
            gameOverLoop = setInterval(() => {
                launchFirework();
                if (Math.random() > 0.4) createConfetti();
            }, 500);
        }

        // --- Kh·ªüi t·∫°o s·ª± ki·ªán ---
        startBtn.onclick = () => {
            initAudio();
            startScreen.classList.add('hidden');
            loadQuestion();
        };

        document.getElementById('play-again-button').onclick = () => {
            if (gameOverLoop) clearInterval(gameOverLoop);
            score = 0;
            currentQuestionIndex = 0;
            gameOverModal.classList.add('hidden');
            loadQuestion();
        };

        // CH·ªà PH√ÅT GI·ªåNG N√ìI KHI B·∫§M N√öT LOA
        document.getElementById('replay-speech-button').onclick = () => {
            initAudio();
            // Ki·ªÉm tra tr·∫°ng th√°i hi·ªán t·∫°i ƒë·ªÉ ƒë·ªçc l·ªùi tho·∫°i ph√π h·ª£p
            if (!bonusModal.classList.contains('hidden')) {
                speak("Bonus time! Pick a magic gift!");
            } else if (!gameOverModal.classList.contains('hidden')) {
                speak("Wonderful! You are a pattern superstar!");
            } else {
                speak("What's next?");
            }
        };
    </script>
</body>
</html>
